name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

jobs:
  verify-ci:
    name: Verify CI Success
    runs-on: ubuntu-latest
    
    steps:
      - name: Check latest CI status
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              branch: 'main',
              per_page: 1
            });
            
            if (runs.data.workflow_runs.length === 0) {
              throw new Error('No CI runs found');
            }
            
            const latestRun = runs.data.workflow_runs[0];
            if (latestRun.conclusion !== 'success') {
              throw new Error(`Latest CI run failed with status: ${latestRun.conclusion}`);
            }
            
            console.log('✅ Latest CI run succeeded');

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: verify-ci
    environment:
      name: production
      url: https://opencarbox.vercel.app
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          npm install -g vercel
          vercel --prod --token $VERCEL_TOKEN
        continue-on-error: true

      - name: Notify deployment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentStatus = context.job.status === 'success' ? '✅ Success' : '⚠️ Check logs';
            console.log(`Deployment ${deploymentStatus}`);