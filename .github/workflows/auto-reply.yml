name: auto-reply

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request:
    types: [opened]

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  NODE_VERSION: '20'
  AI_PROVIDER: deepseek
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  NSCALE_API_KEY: ${{ secrets.NSCALE_API_KEY }}
  DEEPSEEK_BASE_URL: ${{ secrets.DEEPSEEK_BASE_URL }}
  NSCALE_HEADER_NAME: ${{ secrets.NSCALE_HEADER_NAME }}

jobs:
  reply:
    name: AI Auto-Reply
    if: github.actor != 'github-actions[bot]'
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - run: pnpm i --frozen-lockfile

      - name: Normalize environment aliases + fail-closed AI preflight
        run: |
          source tools/export_env.sh
          npx tsx tools/preflight.ts ai

      - name: Generate and post autonomous reply
        uses: actions/github-script@v7
        with:
          script: |
            const event = context.eventName;
            const sender = context.payload.sender?.login || 'unknown';

            if (sender.endsWith('[bot]')) {
              core.info('Skipping bot event.');
              return;
            }

            // Resolve target issue/PR number and content
            let issueNumber, sourceText, title;
            if (event === 'issue_comment') {
              issueNumber = context.payload.issue?.number;
              sourceText = context.payload.comment?.body || '';
              title = context.payload.issue?.title || '';
            } else if (event === 'issues') {
              issueNumber = context.payload.issue?.number;
              sourceText = `${context.payload.issue?.title}\n\n${context.payload.issue?.body}`.trim();
              title = context.payload.issue?.title || '';
            } else if (event === 'pull_request') {
              issueNumber = context.payload.pull_request?.number;
              sourceText = `${context.payload.pull_request?.title}\n\n${context.payload.pull_request?.body}`.trim();
              title = context.payload.pull_request?.title || '';
            }

            if (!issueNumber || !sourceText?.trim()) {
              core.info('No target or content found.');
              return;
            }

            if (process.env.AI_PROVIDER !== 'deepseek') {
              throw new Error(`AI_PROVIDER must be deepseek, got: ${process.env.AI_PROVIDER || 'undefined'}`);
            }

            const apiKey = process.env.DEEPSEEK_API_KEY;
            const nscaleApiKey = process.env.NSCALE_API_KEY;
            if (!apiKey || !nscaleApiKey) {
              throw new Error('DEEPSEEK_API_KEY and NSCALE_API_KEY are required for auto-reply.');
            }

            const baseUrl = (process.env.DEEPSEEK_BASE_URL || 'https://api.deepseek.com').replace(/\/$/, '');
            const nscaleHeader = process.env.NSCALE_HEADER_NAME || 'X-NSCALE-API-KEY';

            const res = await fetch(`${baseUrl}/v1/chat/completions`, {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${apiKey}`,
                'Content-Type': 'application/json',
                [nscaleHeader]: nscaleApiKey,
              },
              body: JSON.stringify({
                model: 'deepseek-chat',
                temperature: 0.2,
                max_tokens: 300,
                messages: [
                  { role: 'system', content: 'Du bist ein technischer Maintainer-Assistent. Antworte kurz, konkret, professionell, auf Deutsch. Max 8 Bulletpoints.' },
                  { role: 'user', content: `Event: ${event}\nTitel: ${title}\nNachricht von @${sender}: ${sourceText}` },
                ],
              }),
            });

            if (!res.ok) {
              const statusBody = await res.text();
              throw new Error(`DeepSeek request failed (${res.status}). Body omitted; length=${statusBody.length}`);
            }

            const data = await res.json();
            const aiText = data?.choices?.[0]?.message?.content?.trim();
            if (!aiText) {
              throw new Error('DeepSeek response did not include a reply message.');
            }
            const reply = `${aiText}\n\n_Auto-Reply (${event})_`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: reply,
            });

            core.info(`Posted reply on #${issueNumber}`);
