name: OpenClaw Bot

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# OpenClaw Bot â€“ KI-Assistent fÃ¼r OpenCarBox
# Reagiert auf ALLE Nutzeraktionen: Issues, Kommentare, PRs, Reviews, Monitoring
# PrimÃ¤r: GitHub Models (GITHUB_TOKEN â€“ immer verfÃ¼gbar in Actions)
# Fallback: DeepSeek + NScale
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

on:
  # Fragen & Kommentare
  issue_comment:
    types: [created]
  # Neue Issues, WiedererÃ¶ffnungen
  issues:
    types: [opened, reopened]
  # Pull Requests
  pull_request:
    types: [opened, reopened]
  # PR-Reviews
  pull_request_review:
    types: [submitted]
  # Inline PR-Kommentare
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  NODE_VERSION: '20'
  # DeepSeek Fallback (optional)
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  NSCALE_API_KEY: ${{ secrets.NSCALE_API_KEY }}
  DEEPSEEK_BASE_URL: ${{ secrets.DEEPSEEK_BASE_URL }}
  NSCALE_HEADER_NAME: ${{ secrets.NSCALE_HEADER_NAME }}

jobs:
  openclaw:
    name: ğŸ¤– OpenClaw Bot
    # Bots werden generell Ã¼bersprungen â€“ AUSNAHME:
    # Issues mit Label 'openclaw-bot' (erstellt von Monitoring-Workflows wie
    # health-check oder failure-orchestrator) sollen analysiert werden.
    if: |
      !endsWith(github.actor, '[bot]') ||
      (
        github.event_name == 'issues' &&
        contains(toJson(github.event.issue.labels), 'openclaw-bot')
      )
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}

    steps:
      - name: Generate and post OpenClaw Bot reply
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          NSCALE_API_KEY: ${{ secrets.NSCALE_API_KEY }}
          DEEPSEEK_BASE_URL: ${{ secrets.DEEPSEEK_BASE_URL }}
          NSCALE_HEADER_NAME: ${{ secrets.NSCALE_HEADER_NAME }}
        with:
          script: |
            const event = context.eventName;
            const sender = context.payload.sender?.login || 'unknown';

            // Alle Bots ausschlieÃŸen
            if (sender.endsWith('[bot]') || sender === 'github-actions') {
              core.info(`Skipping bot actor: ${sender}`);
              return;
            }

            // â”€â”€ Event-Daten extrahieren â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let issueNumber, sourceText, title, eventLabel;

            if (event === 'issue_comment') {
              issueNumber = context.payload.issue?.number;
              sourceText  = context.payload.comment?.body || '';
              title       = context.payload.issue?.title || '';
              eventLabel  = 'Kommentar in Issue';
            } else if (event === 'issues') {
              issueNumber = context.payload.issue?.number;
              sourceText  = `${context.payload.issue?.title}\n\n${context.payload.issue?.body || ''}`.trim();
              title       = context.payload.issue?.title || '';
              eventLabel  = context.payload.action === 'reopened' ? 'Issue wiedererÃ¶ffnet' : 'Neues Issue';
            } else if (event === 'pull_request') {
              issueNumber = context.payload.pull_request?.number;
              sourceText  = `${context.payload.pull_request?.title}\n\n${context.payload.pull_request?.body || ''}`.trim();
              title       = context.payload.pull_request?.title || '';
              eventLabel  = context.payload.action === 'reopened' ? 'PR wiedererÃ¶ffnet' : 'Neuer Pull Request';
            } else if (event === 'pull_request_review') {
              issueNumber = context.payload.pull_request?.number;
              sourceText  = context.payload.review?.body || '';
              title       = context.payload.pull_request?.title || '';
              eventLabel  = `PR-Review (${context.payload.review?.state || 'submitted'})`;
              if (!sourceText?.trim()) {
                core.info('Empty review body â€“ skipping.');
                return;
              }
            } else if (event === 'pull_request_review_comment') {
              issueNumber = context.payload.pull_request?.number;
              sourceText  = context.payload.comment?.body || '';
              title       = context.payload.pull_request?.title || '';
              eventLabel  = 'Inline PR-Kommentar';
            } else {
              core.info(`Unhandled event type: ${event}`);
              return;
            }

            if (!issueNumber || !sourceText?.trim()) {
              core.info('No target or content found â€“ skipping.');
              return;
            }

            core.info(`OpenClaw Bot processing: ${eventLabel} #${issueNumber} by @${sender}`);

            const systemPrompt = [
              'Du bist OpenClaw Bot, der technische KI-Assistent des OpenCarBox-Projekts (Next.js, Supabase, TypeScript).',
              'Antworte immer auf Deutsch â€“ kurz, konkret, professionell.',
              'Maximal 8 Stichpunkte oder kurze AbsÃ¤tze.',
              'Bei Fehlern: Ursache benennen + LÃ¶sungsschritte.',
              'Bei Anfragen: direkte Empfehlung + ggf. Code-Snippet.',
              'Bei PRs: technische QualitÃ¤t, Sicherheit, Architektur prÃ¼fen.',
              'Keine Floskeln, keine unnÃ¶tigen Einleitungen.',
            ].join(' ');

            const userMessage = `Event: ${eventLabel}\nTitel: ${title}\nNachricht von @${sender}:\n\n${sourceText}`;

            let aiText = null;
            let providerUsed = 'none';

            // â”€â”€ PRIMÃ„R: GitHub Models (immer verfÃ¼gbar via GITHUB_TOKEN) â”€â”€
            try {
              const res = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                method: 'POST',
                headers: {
                  Authorization: `Bearer ${process.env.GITHUB_TOKEN}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  model: 'gpt-4o-mini',
                  temperature: 0.2,
                  max_tokens: 400,
                  messages: [
                    { role: 'system', content: systemPrompt },
                    { role: 'user',   content: userMessage  },
                  ],
                }),
              });
              if (res.ok) {
                const data = await res.json();
                aiText = data?.choices?.[0]?.message?.content?.trim();
                providerUsed = 'GitHub Models (gpt-4o-mini)';
                core.info('âœ… GitHub Models responded successfully.');
              } else {
                const errBody = await res.text();
                core.warning(`GitHub Models failed (HTTP ${res.status}): ${errBody.slice(0, 200)} â€“ trying DeepSeek fallback.`);
              }
            } catch (e) {
              core.warning(`GitHub Models error: ${e.message} â€“ trying DeepSeek fallback.`);
            }

            // â”€â”€ FALLBACK: DeepSeek + NScale â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (!aiText) {
              const apiKey      = process.env.DEEPSEEK_API_KEY;
              const nscaleKey   = process.env.NSCALE_API_KEY;
              if (!apiKey) {
                core.setFailed('âŒ Kein KI-Anbieter verfÃ¼gbar: GITHUB_TOKEN (GitHub Models) schlug fehl und DEEPSEEK_API_KEY ist nicht gesetzt.');
                return;
              }
              const baseUrl      = (process.env.DEEPSEEK_BASE_URL || 'https://api.deepseek.com').replace(/\/$/, '');
              const nscaleHeader = process.env.NSCALE_HEADER_NAME || 'X-NSCALE-API-KEY';
              const headers      = {
                Authorization:    `Bearer ${apiKey}`,
                'Content-Type': 'application/json',
              };
              if (nscaleKey) headers[nscaleHeader] = nscaleKey;

              try {
                const res = await fetch(`${baseUrl}/v1/chat/completions`, {
                  method: 'POST',
                  headers,
                  body: JSON.stringify({
                    model: 'deepseek-chat',
                    temperature: 0.2,
                    max_tokens: 400,
                    messages: [
                      { role: 'system', content: systemPrompt },
                      { role: 'user',   content: userMessage  },
                    ],
                  }),
                });
                if (!res.ok) {
                  const errBody = await res.text();
                  core.setFailed(`âŒ DeepSeek-Fallback fehlgeschlagen (HTTP ${res.status}). LÃ¤nge: ${errBody.length}`);
                  return;
                }
                const data = await res.json();
                aiText = data?.choices?.[0]?.message?.content?.trim();
                providerUsed = 'DeepSeek (Fallback)';
                core.info('âœ… DeepSeek Fallback responded successfully.');
              } catch (e) {
                core.setFailed(`âŒ DeepSeek-Fallback error: ${e.message}`);
                return;
              }
            }

            if (!aiText) {
              core.setFailed('âŒ KI-Antwort leer â€“ kein Kommentar gepostet.');
              return;
            }

            // â”€â”€ Kommentar posten â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const repoUrl = context.payload.repository?.html_url || '';
            const reply   = `${aiText}\n\n---\n_ğŸ¤– [OpenClaw Bot](${repoUrl}) Â· ${eventLabel} Â· via ${providerUsed}_`;

            await github.rest.issues.createComment({
              owner:        context.repo.owner,
              repo:         context.repo.repo,
              issue_number: issueNumber,
              body:         reply,
            });

            core.info(`âœ… OpenClaw Bot posted reply on #${issueNumber} (${providerUsed})`);
