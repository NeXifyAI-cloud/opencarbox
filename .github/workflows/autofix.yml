name: autofix

on:
  workflow_run:
    workflows: ["ci"]
    types: [completed]

concurrency:
  group: autofix-${{ github.event.workflow_run.head_branch || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  NODE_VERSION: '20'
  JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
  JULES_BASE_URL: ${{ secrets.JULES_BASE_URL }}

jobs:
  safe_autofix:
    name: Safe Autofix
    if: >-
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.name == 'ci' &&
      github.event.workflow_run.head_repository.full_name == github.repository
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          persist-credentials: false
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install system tools
        run: sudo apt-get update && sudo apt-get install -y jq gh

      - run: npm ci

      - name: Normalize environment aliases
        run: source tools/export_env.sh

      - name: Safe fixes (format + lint)
        run: |
          npx prettier --write . || true
          npx eslint . --fix || true

      - name: Classify changed files
        id: classify
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "check_profile=none" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CHANGED_FILES="$(git diff --name-only)"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"
          {
            echo "changed_files<<EOF"
            echo "$CHANGED_FILES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          # Use grep instead of rg (ripgrep not available in CI)
          if echo "$CHANGED_FILES" | grep -qE '^(src/|app/|lib/|components/|tools/|supabase/|\.github/workflows/)'; then
            echo "check_profile=full" >> "$GITHUB_OUTPUT"
          else
            echo "check_profile=lint-only" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate Prisma Client
        if: steps.classify.outputs.has_changes == 'true'
        run: npm run db:generate

      - name: Run required checks
        id: required_checks
        if: steps.classify.outputs.has_changes == 'true'
        run: |
          PROFILE="${{ steps.classify.outputs.check_profile }}"
          PASSED=true

          if [ "$PROFILE" = "full" ]; then
            npm run lint || PASSED=false
            npm run typecheck || PASSED=false
            npm run test || PASSED=false
            npm run build || PASSED=false
          else
            npm run lint || PASSED=false
          fi

          echo "passed=$PASSED" >> "$GITHUB_OUTPUT"

      - name: Create PR if changes pass
        if: steps.classify.outputs.has_changes == 'true' && steps.required_checks.outputs.passed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: '0'
        run: |
          BR="codex/autofix-safe-${{ github.event.workflow_run.id }}"

          # Max 2 open autofix PRs guardrail
          OPEN_COUNT="$(gh pr list --state open --label autofix --json number --jq 'length')"
          if [ "$OPEN_COUNT" -ge 2 ]; then
            echo "Skipping: already $OPEN_COUNT open autofix PRs (max 2)."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BR"
          git add -A
          git commit -m "chore: safe autofix (format/lint)"
          git push https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git "$BR"

          gh label create autofix --color 1d76db --description "Automated safe autofix PR" 2>/dev/null || true
          gh pr create \
            --title "chore: safe autofix" \
            --body "Sichere Autofixes (Formatierung/Lint) auf dem fehlerhaften Branch angewendet." \
            --base "${{ github.event.workflow_run.head_branch }}" \
            --label autofix

      - name: Log check failure
        if: steps.classify.outputs.has_changes == 'true' && steps.required_checks.outputs.passed != 'true'
        run: echo "Autofix changes were created but checks failed. Skipping PR creation."

      - name: Sanitize user input
        id: sanitize
        run: |
          # Escape special characters in issue body and comments
          SANITIZED_ISSUE_BODY=$(echo "${{ github.event.issue.body }}" | jq -Rs '.' | sed 's/[\]/\\/g' 2>/dev/null || echo '""')
          SANITIZED_COMMENT_BODY=$(echo "${{ github.event.issue_comment.body }}" | jq -Rs '.' | sed 's/[\]/\\/g' 2>/dev/null || echo '""')
          SANITIZED_PR_BODY=$(echo "${{ github.event.pull_request.body }}" | jq -Rs '.' | sed 's/[\]/\\/g' 2>/dev/null || echo '""')
          
          echo "SANITIZED_ISSUE_BODY=$SANITIZED_ISSUE_BODY" >> $GITHUB_ENV
          echo "SANITIZED_COMMENT_BODY=$SANITIZED_COMMENT_BODY" >> $GITHUB_ENV
          echo "SANITIZED_PR_BODY=$SANITIZED_PR_BODY" >> $GITHUB_ENV
          echo "âœ… User input sanitized (special chars escaped)"

      - name: Route failure to Jules
        if: failure()
        run: |
          source tools/export_env.sh
          if [ -z "${JULES_API_KEY:-}" ] || [ -z "${JULES_BASE_URL:-}" ]; then
            echo "Jules routing skipped."
            exit 0
          fi
          curl -sS -X POST "${JULES_BASE_URL%/}/api/events" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $JULES_API_KEY" \
            -d "{\"source\":\"autofix\",\"kind\":\"error\",\"name\":\"autofix.failed\",\"metadata\":{\"branch\":\"${{ github.event.workflow_run.head_branch }}\",\"run_id\":\"${{ github.run_id }}\"}}"
