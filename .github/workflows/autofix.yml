name: Autofix Scope Guard

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read
  pull-requests: write

jobs:
  scope-guard:
    if: contains(github.event.pull_request.labels.*.name, 'autofix')
    runs-on: ubuntu-latest

    steps:
      - name: Block forbidden path changes for auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail

          files=$(gh api "repos/$REPO/pulls/$PR_NUMBER/files?per_page=200" --paginate | jq -r '.[].filename')
          echo "$files" > changed-files.txt

          if rg -n "^(prisma/migrations/|supabase/migrations/|\.env|vercel\.json$)" changed-files.txt >/dev/null; then
            gh pr edit "$PR_NUMBER" --repo "$REPO" --add-label needs-human
            gh pr merge --disable-auto "https://github.com/$REPO/pull/$PR_NUMBER" || true
            gh pr comment "$PR_NUMBER" --repo "$REPO" --body "⚠️ Autofix Scope Guard: Verbotene Pfade geändert (z. B. Migrationen/.env/vercel.json). Auto-Merge deaktiviert, Label \\`needs-human\\` gesetzt."
            exit 1
          fi

          gh pr comment "$PR_NUMBER" --repo "$REPO" --body "✅ Autofix Scope Guard: Änderungen innerhalb des sicheren Envelopes."
