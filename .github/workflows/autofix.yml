name: Autofix Automation

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]
  workflow_run:
    workflows: [Fast Gate, Full Gate]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  actions: read
  issues: write

jobs:
  scope-guard:
    if: github.event_name == 'pull_request_target' && contains(github.event.pull_request.labels.*.name, 'autofix')
    runs-on: ubuntu-latest

    steps:
      - name: Block forbidden path changes for auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail

          files=$(gh api "repos/$REPO/pulls/$PR_NUMBER/files?per_page=200" --paginate | jq -r '.[].filename')
          echo "$files" > changed-files.txt

          if rg -n "^(prisma/migrations/|supabase/migrations/|\.env|vercel\.json$)" changed-files.txt >/dev/null; then
            gh pr edit "$PR_NUMBER" --repo "$REPO" --add-label needs-human
            gh pr merge --disable-auto "https://github.com/$REPO/pull/$PR_NUMBER" || true
            gh pr comment "$PR_NUMBER" --repo "$REPO" --body "⚠️ Autofix Scope Guard: Verbotene Pfade geändert (z. B. Migrationen/.env/vercel.json). Auto-Merge deaktiviert, Label \`needs-human\` gesetzt."
            exit 1
          fi

          gh pr comment "$PR_NUMBER" --repo "$REPO" --body "✅ Autofix Scope Guard: Änderungen innerhalb des sicheren Envelopes."

  autofix-on-failure:
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.head_branch != 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout failed SHA
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: npm

      - name: Create autofix attempt issue (max 2 attempts per SHA)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SHA: ${{ github.event.workflow_run.head_sha }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          set -euo pipefail
          COUNT=$(gh issue list --repo "$REPO" --search "Autofix-Attempt $SHA in:title" --state all --json number --jq 'length')
          if [ "$COUNT" -ge 2 ]; then
            gh issue create --repo "$REPO" --title "needs-human: autofix loop limit reached for $SHA" --body "Autofix wurde bereits 2x für SHA $SHA versucht. Bitte manuell prüfen."
            exit 0
          fi
          gh issue create --repo "$REPO" --title "Autofix-Attempt $SHA #$((COUNT+1))" --body "Automatischer Versuch für fehlgeschlagenen Workflow auf Branch \`$BRANCH\`."

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Safe autofix pass
        shell: bash
        run: |
          set -euo pipefail
          npm run security:scan-secrets
          npm run type-check || npm run lint:fix || true
          npm run lint || npm run lint:fix || true

      - name: Open autofix PR when changes exist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          SHA: ${{ github.event.workflow_run.head_sha }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No safe autofix changes found."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          FIX_BRANCH="repair/${BRANCH}/$(date +%Y%m%d)-${SHA:0:7}"
          git switch -c "$FIX_BRANCH"
          git add -A
          git commit -m "fix(ci): safe autofix for $BRANCH"
          git push origin "$FIX_BRANCH"

          gh pr create --repo "$REPO" --base "$BRANCH" --head "$FIX_BRANCH" \
            --title "fix(branch): repair $BRANCH" \
            --body "## Root cause\nWorkflow failure on SHA \\`$SHA\\`.\n\n## Fix\nApplied safe autofix envelope (lint/type/security).\n\n## Verification\n- npm run security:scan-secrets\n- npm run type-check\n- npm run lint\n\n## Risk\nLow (no migrations/secrets/major upgrades)."
