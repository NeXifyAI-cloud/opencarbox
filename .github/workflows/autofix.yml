name: autofix (NSCALE/DeepSeek)

on:
  workflow_run:
    workflows: ["fast-gate", "full-gate"]
    types: [completed]

permissions:
  contents: read
  actions: read
  pull-requests: write

concurrency:
  group: autofix-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: false

env:
  CI: "true"
  TZ: "UTC"
  MAX_AUTOFIX_ATTEMPTS: "2"

jobs:
  run:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      - name: Download logs
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          name: ci-logs
          path: logs
        continue-on-error: true

      - name: Ensure error summary
        shell: bash
        run: |
          mkdir -p logs
          test -f logs/workflow.log || cat logs/*.log > logs/workflow.log 2>/dev/null || true
          node scripts/ci-classify-failure.js logs/workflow.log || true
          test -f logs/error-summary.json || echo '{"kind":"unknown"}' > logs/error-summary.json

      - name: Stop on infra-only failures
        shell: bash
        run: |
          node - <<'NODE'
          const fs=require('fs');
          const s=JSON.parse(fs.readFileSync('logs/error-summary.json','utf8'));
          if (s.kind === 'infra') process.exit(50);
          NODE
        continue-on-error: true

      - name: Create autofix branch
        id: br
        shell: bash
        run: |
          sha="${{ github.event.workflow_run.head_sha }}"
          short="${sha:0:7}"
          echo "name=autofix/${short}" >> $GITHUB_OUTPUT
          git checkout -B "autofix/${short}"

      - name: AI Autofix
        env:
          NSCALE_API_KEY: ${{ secrets.NSCALE_API_KEY }}
          NSCALE_BASE_URL: ${{ vars.NSCALE_BASE_URL }}
          NSCALE_MODEL: ${{ vars.NSCALE_MODEL }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_BASE_URL: ${{ vars.DEEPSEEK_BASE_URL }}
          DEEPSEEK_MODEL: ${{ vars.DEEPSEEK_MODEL }}
        run: npm run ai:autofix

      - name: Push branch
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        run: |
          git push -u "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" "${{ steps.br.outputs.name }}" --force

      - name: Create or update PR
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        shell: bash
        run: |
          head="${{ steps.br.outputs.name }}"
          base="${{ github.event.workflow_run.head_branch }}"
          title="fix(ci): autofix for ${base} (${head})"
          body="Automated fix (NSCALE/DeepSeek only).\nSource: ${{ github.event.workflow_run.html_url }}\n"
          if gh pr list --head "$head" --json number -q '.[0].number' >/dev/null 2>&1; then
            n="$(gh pr list --head "$head" --json number -q '.[0].number')"
            gh pr edit "$n" --title "$title" --body "$body" || true
          else
            gh pr create --head "$head" --base "$base" --title "$title" --body "$body" --label "autofix" -f
          fi
