name: Auto-merge Autofix PRs

on:
  pull_request:
    types: [labeled, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: automerge-autofix-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  automerge:
    if: >
      github.event.pull_request.draft == false &&
      contains(github.event.pull_request.labels.*.name, 'autofix') &&
      !contains(github.event.pull_request.labels.*.name, 'needs-human') &&
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.head.repo.fork == false &&
      contains(fromJson('["MEMBER","COLLABORATOR","OWNER"]'), github.event.pull_request.author_association)
    runs-on: ubuntu-latest
    steps:
      - name: Wait for required checks (Fast + Full) to succeed
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.pull_request.head.sha }}
        shell: bash
        run: |
          set -euo pipefail

          required=("fast-gate" "full-gate")
          max_attempts=60
          sleep_seconds=10

          for ((attempt=1; attempt<=max_attempts; attempt++)); do
            echo "Polling check runs for $SHA (attempt $attempt/$max_attempts)..."

            checks_json=$(gh api "repos/$REPO/commits/$SHA/check-runs")

            missing=()
            failing=()

            for name in "${required[@]}"; do
              result=$(jq -r --arg n "$name" '
                [ .check_runs[] | select(.name == $n) ]
                | if length == 0 then "MISSING"
                  else (.[0].status + ":" + (.[0].conclusion // "null"))
                  end
              ' <<<"$checks_json")

              case "$result" in
                completed:success)
                  echo "✅ $name passed"
                  ;;
                MISSING)
                  echo "⏳ $name not reported yet"
                  missing+=("$name")
                  ;;
                *)
                  echo "❌ $name not successful ($result)"
                  failing+=("$name:$result")
                  ;;
              esac
            done

            if [ ${#failing[@]} -gt 0 ]; then
              echo "Required checks failed: ${failing[*]}"
              exit 1
            fi

            if [ ${#missing[@]} -eq 0 ]; then
              echo "All required checks succeeded."
              exit 0
            fi

            sleep "$sleep_seconds"
          done

          echo "Timed out waiting for required checks to complete successfully."
          exit 1

      - name: Enable auto-merge (squash)
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        run: gh pr merge "${{ github.event.pull_request.number }}" --auto --squash --delete-branch
