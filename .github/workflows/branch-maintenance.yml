name: branch-maintenance

on:
  schedule:
    - cron: "17 2 * * *"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: branch-maintenance
  cancel-in-progress: false

env:
  CI: "true"
  TZ: "UTC"
  BASE_BRANCH: "main"
  QUEUE_LABEL: "nexifyai:queue"
  EXCLUDE: "dependabot/*,autofix/*,repair/*"

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Fetch all
        run: git fetch --all --prune

      - name: Create repair PRs
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          IFS=',' read -r -a EXC <<< "${EXCLUDE}"
          base="${BASE_BRANCH}"
          date_tag="$(date -u +%Y%m%d)"

          mapfile -t branches < <(git for-each-ref --format='%(refname:short)' refs/remotes/origin | sed 's#^origin/##' | grep -v '^HEAD$' | sort)

          for br in "${branches[@]}"; do
            [ "$br" = "$base" ] && continue
            skip=0
            for p in "${EXC[@]}"; do [[ "$br" == $p ]] && skip=1; done
            [ $skip -eq 1 ] && continue

            repair="repair/${br//\//-}/${date_tag}"
            git checkout -B "$repair" "origin/$br"

            if ! git merge --no-edit "origin/$base"; then
              git merge --abort || true
              git push -u origin "$repair"
              gh pr create --head "$repair" --base "$base" \
                --title "fix(branch): repair $br (merge conflict)" \
                --body "Automated maintenance hit a merge conflict. Human resolution required.\nOriginal: $br\nBase: $base" \
                --label "maintenance" --label "needs-human" -f || true
              continue
            fi

            git push -u origin "$repair"
            gh pr create --head "$repair" --base "$base" \
              --title "fix(branch): repair $br (sync with $base)" \
              --body "Automated maintenance merged base into branch. Queued for autonomous verification/fix." \
              --label "maintenance" --label "${QUEUE_LABEL}" -f || true
          done
