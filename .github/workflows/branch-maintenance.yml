name: Branch maintenance (repair existing branches)

on:
  schedule:
    - cron: "17 2 * * *"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: branch-maintenance
  cancel-in-progress: false

env:
  CI: "true"
  TZ: "UTC"
  BASE_BRANCH: "main"
  QUEUE_LABEL: "nexifyai:queue"
  EXCLUDE: "dependabot/*,autofix/*,repair/*"

jobs:
  maintenance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v6
        with:
          fetch-depth: 0

      - name: Fetch all
        run: git fetch --all --prune

      - name: Build branch list
        shell: bash
        run: |
          set -euo pipefail
          IFS=',' read -r -a EXC <<< "${EXCLUDE}"
          git for-each-ref --format='%(refname:short)' refs/remotes/origin \
            | sed 's#^origin/##' | grep -v '^HEAD$' | sort > all.txt
          > branches.txt
          while IFS= read -r b; do
            [ "$b" = "${BASE_BRANCH}" ] && continue
            skip=0
            for p in "${EXC[@]}"; do [[ "$b" == $p ]] && skip=1; done
            [ $skip -eq 0 ] && echo "$b" >> branches.txt
          done < all.txt
          echo "Selected $(wc -l < branches.txt) branches."

      - name: Create repair PRs (queued)
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          base="${BASE_BRANCH}"
          date_tag="$(date -u +%Y%m%d)"

          while IFS= read -r br; do
            repair="repair/${br//\//-}/${date_tag}"
            git checkout -B "$repair" "origin/$br"

            if ! git merge --no-edit "origin/$base"; then
              git merge --abort || true
              git push -u origin "$repair"
              gh pr create --head "$repair" --base "$base" \
                --title "fix(branch): repair $br (merge conflict)" \
                --body "Automated maintenance hit a merge conflict. Human resolution required.\n\nOriginal: $br\nBase: $base" \
                --label "maintenance" --label "needs-human" -f || true
              continue
            fi

            git push -u origin "$repair"
            # Create PR and put it into queue
            if gh pr list --head "$repair" --json number -q '.[0].number' >/dev/null 2>&1; then
              pr="$(gh pr list --head "$repair" --json number -q '.[0].number')"
              gh pr edit "$pr" --add-label "${QUEUE_LABEL}" >/dev/null 2>&1 || true
            else
              gh pr create --head "$repair" --base "$base" \
                --title "fix(branch): repair $br (sync with $base)" \
                --body "Automated branch maintenance: merged $base into branch.\n\nOriginal: $br\nBase: $base\n\nQueued for autonomous verification/fixes." \
                --label "maintenance" --label "${QUEUE_LABEL}" -f || true
            fi
          done < branches.txt
