name: Enforce Pinned GitHub Actions

on:
  pull_request:
    paths:
      - '.github/workflows/*.yml'
  push:
    branches: [main, develop]
    paths:
      - '.github/workflows/*.yml'

jobs:
  check-pinned-actions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Validate uses are SHA-pinned
        run: |
          python - <<'PY'
          import pathlib
          import re
          import sys

          uses_re = re.compile(r'^\s*-?\s*uses:\s*([^\s#]+)')
          pinned_re = re.compile(r'^[^@\s]+@[0-9a-f]{40}$')

          violations = []
          for workflow in sorted(pathlib.Path('.github/workflows').glob('*.yml')):
              for idx, line in enumerate(workflow.read_text().splitlines(), start=1):
                  m = uses_re.match(line)
                  if not m:
                      continue

                  value = m.group(1)
                  if value.startswith('./') or value.startswith('docker://'):
                      continue

                  if not pinned_re.match(value):
                      violations.append((workflow, idx, value))

          if violations:
              print('Found unpinned GitHub Action references:')
              for wf, line, value in violations:
                  print(f' - {wf}:{line}: {value}')
              sys.exit(1)

          print('All GitHub Actions are pinned to full commit SHAs.')
          PY
