# Auto-Retry & Flaky Guard (Auftrag 24)
name: ci-retry

on:
  workflow_run:
    workflows: [ci]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID to retry (for testing)'
        required: false

concurrency:
  group: ci-retry-${{ github.event.workflow_run.id || github.run_id }}
  cancel-in-progress: true

permissions:
  actions: write
  issues: write

env:
  NODE_VERSION: '20'
  MAX_RETRIES: '1'

jobs:
  classify-and-retry:
    name: Classify & Retry
    if: >-
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.name == 'ci'
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - run: pnpm i --frozen-lockfile

      - name: Check retry count
        id: retry_count
        uses: actions/github-script@v8
        with:
          script: |
            const runId = context.payload.workflow_run.id;
            // Check if this run was already a retry by searching for retry marker
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              labels: 'ci-retry',
              per_page: 10,
            });
            const marker = `retry-for-${runId}`;
            const alreadyRetried = issues.some(i => i.body && i.body.includes(marker));
            core.setOutput('already_retried', alreadyRetried ? 'true' : 'false');
            core.setOutput('marker', marker);

      - name: Fetch failed job logs (summary)
        id: logs
        if: steps.retry_count.outputs.already_retried != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const run = context.payload.workflow_run;
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run.id,
              filter: 'latest',
            });

            const failedSteps = jobs.jobs
              .filter(j => j.conclusion === 'failure')
              .flatMap(j => (j.steps || [])
                .filter(s => s.conclusion === 'failure')
                .map(s => s.name)
              );

            // Use step names as heuristic for classification
            const summary = failedSteps.join(', ');
            core.setOutput('failed_steps', summary);

      - name: Classify failure
        id: classify
        if: steps.retry_count.outputs.already_retried != 'true'
        run: |
          STEPS="${{ steps.logs.outputs.failed_steps }}"
          # Use the TypeScript classifier
          RESULT=$(npx tsx -e "
            import { classifyFailure, isTransient, suggestedLabels } from './tools/ci_failure_classify';
            const input = process.argv[1] || '';
            const result = classifyFailure(input);
            console.log(JSON.stringify({
              failureClass: result.failureClass,
              retryable: isTransient(result),
              labels: suggestedLabels(result),
            }));
          " "$STEPS" 2>/dev/null || echo '{"failureClass":"unknown","retryable":false,"labels":["ci-failure","needs-human"]}')

          echo "result=$RESULT" >> "$GITHUB_OUTPUT"
          RETRYABLE=$(echo "$RESULT" | jq -r '.retryable')
          CLASS=$(echo "$RESULT" | jq -r '.failureClass')
          echo "retryable=$RETRYABLE" >> "$GITHUB_OUTPUT"
          echo "failure_class=$CLASS" >> "$GITHUB_OUTPUT"

      - name: Re-run workflow (transient failure)
        if: >-
          steps.retry_count.outputs.already_retried != 'true' &&
          steps.classify.outputs.retryable == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const runId = context.payload.workflow_run.id;
            await github.rest.actions.reRunWorkflowFailedJobs({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });
            core.info(`Re-running failed jobs for run ${runId}`);

      - name: Label flaky test issue
        if: >-
          steps.classify.outputs.failure_class == 'test-flaky'
        uses: actions/github-script@v8
        with:
          script: |
            // Ensure label exists
            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'flaky-test',
              });
            } catch {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'flaky-test',
                color: 'ff9800',
                description: 'Test is flaky and needs investigation',
              });
            }

            // Find or create issue for flaky tests
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'flaky-test',
              per_page: 5,
            });

            const run = context.payload.workflow_run;
            if (issues.length > 0) {
              // Update existing flaky test issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `Flaky test detected again in [run #${run.run_number}](${run.html_url}).\nBranch: \`${run.head_branch}\``,
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Flaky test detected in CI',
                body: `A flaky test was detected in [run #${run.run_number}](${run.html_url}).\nBranch: \`${run.head_branch}\`\n\nPlease investigate and stabilize the test.`,
                labels: ['flaky-test', 'ci-failure'],
              });
            }
