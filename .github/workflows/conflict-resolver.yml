name: conflict-resolver

on:
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours (not every 30 min!)
  workflow_dispatch:

concurrency:
  group: conflict-resolver-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  NODE_VERSION: '22'
  # AI Provider Configuration (DeepSeek-only)
  AI_PROVIDER: ${{ vars.AI_PROVIDER || 'deepseek' }}
  AI_AUTO_SELECT: ${{ vars.AI_AUTO_SELECT || 'true' }}
  # DeepSeek + NSCALE
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  NSCALE_API_KEY: ${{ secrets.NSCALE_API_KEY }}
  DEEPSEEK_BASE_URL: ${{ secrets.DEEPSEEK_BASE_URL }}
  NSCALE_HEADER_NAME: ${{ secrets.NSCALE_HEADER_NAME }}
  JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
  JULES_BASE_URL: ${{ secrets.JULES_BASE_URL }}

jobs:
  resolve:
    name: Resolve PR Conflicts
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install system tools
        run: sudo apt-get update && sudo apt-get install -y jq gh

      - run: pnpm install

      - name: Normalize environment aliases
        run: |
          source tools/export_env.sh
          pnpm exec tsx tools/preflight.ts ai

      - name: Find PRs with conflicts
        id: prs
        run: |
          prs=$(gh pr list --state open --json number,mergeStateStatus,headRefName,baseRefName,url \
            | jq '[.[] | select(.mergeStateStatus=="DIRTY")]' 2>/dev/null || echo '[]')
          {
            echo "prs<<EOF"
            echo "$prs"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          echo "Found $(echo "$prs" | jq 'length') DIRTY PRs"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AI_MAX_CALLS: '20'
          max_conflict_files: '10'
          max_file_bytes: '200000'
          binary_heuristic_threshold: '0.15'
          FORBID_WORKFLOW_EDITS: '1'

      - name: Resolve conflicts (oldest DIRTY PR first)
        if: steps.prs.outputs.prs != '[]'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AI_MAX_CALLS: '20'
          FORBID_WORKFLOW_EDITS: '1'
          HUSKY: '0'
        run: |
          # Max 2 open codex PRs guardrail
          OPEN_COUNT="$(gh pr list --state open --search 'head:codex/' --json number --jq 'length')"
          if [ "$OPEN_COUNT" -ge 2 ]; then
            echo "Skipping: already $OPEN_COUNT open codex/* PRs (max 2)."
            exit 0
          fi

          # Get oldest DIRTY PR
          pr="$(gh pr list --state open --json number,mergeStateStatus,headRefName,baseRefName,createdAt \
            --jq '[.[] | select(.mergeStateStatus=="DIRTY")] | sort_by(.createdAt) | .[0]')"

          [ -z "$pr" ] || [ "$pr" = "null" ] && { echo "No DIRTY PRs"; exit 0; }

          num="$(echo "$pr" | jq -r .number)"
          head="$(echo "$pr" | jq -r .headRefName)"
          base="$(echo "$pr" | jq -r .baseRefName)"

          echo "Resolving PR #$num ($head -> $base)"

          git fetch origin "$base" "$head"
          git checkout -B "codex/conflictfix-$num" "origin/$head"

          if git rebase "origin/$base"; then
            echo "Rebase OK"
          else
            echo "Rebase conflict - attempting AI merge..."
            git rebase --abort || true
            pnpm exec tsx tools/ai_merge_conflicts.ts --base "origin/$base" --head "origin/$head" || {
              echo "AI merge failed"
              exit 0
            }
          fi

          # Validate
          pnpm run db:generate && pnpm run lint && pnpm run typecheck && pnpm test -- --run && pnpm run build || {
            echo "Validation failed, skipping PR"
            exit 0
          }

          git add -A
          git diff --cached --quiet && { echo "No changes"; exit 0; }

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: resolve conflicts for #$num"
          git push -u origin "codex/conflictfix-$num" --force-with-lease

          gh pr create \
            --title "chore: resolve conflicts for #$num" \
            --body "## Was geändert\n- Rebase der betroffenen PR auf den aktuellen Base-Branch.\n- Bei Rebase-Konflikt: DeepSeek-only Merge für Konfliktdateien mit Guardrails.\n\n## Warum\n- Mergebarkeit wiederherstellen, ohne direkten Push auf bestehende PR-Branches.\n\n## Wie getestet\n- pnpm run lint\n- pnpm run typecheck\n- pnpm test -- --run\n- pnpm run build\n\n## Risiko/Backout\n- Risiko: Falsche Konfliktauflösung in inhaltlich komplexen Dateien.\n- Backout: Erstellte Fix-PR schließen oder revertieren; Ursprungs-PR unverändert erneut bearbeiten." \
            --base "$base" \
            --head "codex/conflictfix-$num" || true


      - name: Sanitize user input
        id: sanitize
        run: |
          # Escape special characters in issue body and comments
          SANITIZED_ISSUE_BODY=$(echo "${{ github.event.issue.body }}" | jq -Rs '.' | sed 's/[\]/\\/g' 2>/dev/null || echo '""')
          SANITIZED_COMMENT_BODY=$(echo "${{ github.event.issue_comment.body }}" | jq -Rs '.' | sed 's/[\]/\\/g' 2>/dev/null || echo '""')
          SANITIZED_PR_BODY=$(echo "${{ github.event.pull_request.body }}" | jq -Rs '.' | sed 's/[\]/\\/g' 2>/dev/null || echo '""')
          
          echo "SANITIZED_ISSUE_BODY=$SANITIZED_ISSUE_BODY" >> $GITHUB_ENV
          echo "SANITIZED_COMMENT_BODY=$SANITIZED_COMMENT_BODY" >> $GITHUB_ENV
          echo "SANITIZED_PR_BODY=$SANITIZED_PR_BODY" >> $GITHUB_ENV
          echo "✅ User input sanitized (special chars escaped)"

      - name: Route failure to Jules
        if: failure()
        run: |
          source tools/export_env.sh
          if [ -z "${JULES_API_KEY:-}" ] || [ -z "${JULES_BASE_URL:-}" ]; then
            echo "Jules routing skipped."
            exit 0
          fi
          curl -sS -X POST "${JULES_BASE_URL%/}/api/events" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $JULES_API_KEY" \
            -d "{\"source\":\"conflict-resolver\",\"kind\":\"error\",\"name\":\"conflict-resolver.failed\",\"metadata\":{\"run_id\":\"${{ github.run_id }}\"}}"
