name: failure-orchestrator

on:
  workflow_run:
    workflows:
      - ci
      - Security
      - Auto-Deploy Production
      - autofix
      - conflict-resolver
      - auto-improve
      - bootstrap
      - Auto-Merge
      - auto-reply
    types: [completed]

concurrency:
  group: failure-orchestrator-${{ github.event.workflow_run.id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read
  issues: write

env:
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_PROJEKT_URL || secrets.NEXT_PUBLIC_SUPABASE_URL }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || secrets.SUPABASE_PUBLISHABLE_KEY || secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || secrets.SUPABASE_SECRET_KEY }}
  AI_PROVIDER: deepseek
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  NSCALE_API_KEY: ${{ secrets.NSCALE_API_KEY }}
  DEEPSEEK_BASE_URL: ${{ secrets.DEEPSEEK_BASE_URL }}
  NSCALE_HEADER_NAME: ${{ secrets.NSCALE_HEADER_NAME }}

jobs:
  route-failure:
    if: ${{ github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.name != 'failure-orchestrator' && github.event.workflow_run.name != 'autofix' && github.event.workflow_run.name != 'ci' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Export normalized env names
        run: source tools/export_env.sh

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install system tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - run: pnpm i --frozen-lockfile

      - name: AI triage eligibility
        id: ai_eligible
        run: |
          source tools/export_env.sh
          if node tools/preflight.ts ai >/dev/null 2>&1; then
            echo "eligible=true" >> "$GITHUB_OUTPUT"
          else
            echo "eligible=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Ensure routing labels exist
        run: |
          if [ "$(gh label list --search failure-routing --json name --jq 'length')" = "0" ]; then
            gh label create failure-routing --color d93f0b --description "Failure orchestrator routing issue"
          fi
          if [ "$(gh label list --search ai-triage --json name --jq 'length')" = "0" ]; then
            gh label create ai-triage --color 5319e7 --description "AI triage is required"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prevent duplicate routing issue per failed run
        id: existing_issue
        run: |
          RUN_REF="run-id:${{ github.event.workflow_run.id }}"
          if gh issue list --state open --search "$RUN_REF in:body" --json number --jq 'length > 0' | grep -q true; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create AI triage routing issue
        if: ${{ steps.existing_issue.outputs.exists != 'true' && steps.ai_eligible.outputs.eligible == 'true' }}
        run: |
          gh issue create \
            --title "AI-Triage required: failed workflow ${{ github.event.workflow_run.name }}" \
            --body "Workflow: ${{ github.event.workflow_run.name }}\nRun: ${{ github.event.workflow_run.html_url }}\nMarker: run-id:${{ github.event.workflow_run.id }}\n\nSafe-Autofix wird in \`autofix.yml\` für CI-Fehlschläge verarbeitet. Dieser Run wird zentral durch den failure-orchestrator nur für Routing/AI-Triage gesteuert.\n\nNächste Schritte:\n1. DeepSeek-Diagnose mit NSCALE-Header ausführen.\n2. Fix als Branch \`codex/{feature}\` bereitstellen.\n3. Runbook/Backlog aktualisieren, falls nötig." \
            --label failure-routing --label ai-triage
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create manual triage routing issue
        if: ${{ steps.existing_issue.outputs.exists != 'true' && steps.ai_eligible.outputs.eligible != 'true' }}
        run: |
          gh issue create \
            --title "Incident: manual triage required for failed workflow ${{ github.event.workflow_run.name }}" \
            --body "Workflow: ${{ github.event.workflow_run.name }}\nRun: ${{ github.event.workflow_run.html_url }}\nMarker: run-id:${{ github.event.workflow_run.id }}\n\nSafe-Autofix wird in \`autofix.yml\` für CI-Fehlschläge verarbeitet. Dieser Run wird zentral durch den failure-orchestrator nur für Routing/Issue-Triage gesteuert.\n\nAI-Preflight ist fail-closed (DeepSeek + NSCALE erforderlich) und war nicht erfüllt. Bitte manuell analysieren, Backlog ergänzen und NOTES/runbook.md aktualisieren." \
            --label failure-routing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
