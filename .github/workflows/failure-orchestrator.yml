name: failure-orchestrator

on:
  workflow_run:
    workflows:
      - ci
      - Security
      - Auto-Deploy Production
      - Deploy Preview
      - Deploy Staging
      - Deploy Production
      - Release
      - autofix
      - conflict-resolver
      - auto-improve
      - bootstrap
      - Auto-Merge
      - Auto-Approve
      - auto-reply
      - codex-controller
      - issue-triage
      - loop-orchestrator
      - ci-retry
      - stale
      - stale-cleanup
      - sync-to-main
      - backlog-sync
      - security-intake
      - pr-labeler
      - health-check
      - AI PR Review
      - AI Issue Analysis
      - AI Code Scan
    types: [completed]

concurrency:
  group: failure-orchestrator-${{ github.event.workflow_run.id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read
  issues: write

env:
  NODE_VERSION: '20'
  # AI Provider Configuration (DeepSeek-only)
  AI_PROVIDER: ${{ vars.AI_PROVIDER || 'deepseek' }}
  AI_AUTO_SELECT: ${{ vars.AI_AUTO_SELECT || 'true' }}
  # DeepSeek + NSCALE
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  NSCALE_API_KEY: ${{ secrets.NSCALE_API_KEY }}
  DEEPSEEK_BASE_URL: ${{ secrets.DEEPSEEK_BASE_URL }}
  NSCALE_HEADER_NAME: ${{ secrets.NSCALE_HEADER_NAME }}
  JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
  JULES_BASE_URL: ${{ secrets.JULES_BASE_URL }}
  FORBID_WORKFLOW_EDITS: 'true'
  AI_MAX_CALLS: '3'

jobs:
  route-failure:
    name: Route Failure
    if: >-
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.name != 'failure-orchestrator'
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    outputs:
      ai_eligible: ${{ steps.ai_eligible.outputs.eligible }}
      marker_exists: ${{ steps.existing_marker.outputs.exists }}
    steps:
      - uses: actions/checkout@v6


      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install system tools
        run: sudo apt-get update && sudo apt-get install -y jq gh

      - run: npm ci

      - name: Sanitize user input
        run: |
          # Defensive input sanitization for workflow event data
          echo "✅ Input sanitization for workflow events enabled"

      - name: Normalize environment aliases
        run: |
          source tools/export_env.sh
          npx tsx tools/preflight.ts ai

      - name: Route failure event to Jules
        run: |
          if [ -z "${JULES_API_KEY:-}" ] || [ -z "${JULES_BASE_URL:-}" ]; then
            echo "Jules routing skipped (missing JULES_API_KEY or JULES_BASE_URL)."
            exit 0
          fi
          jq -n \
            --arg workflow "${{ github.event.workflow_run.name }}" \
            --arg conclusion "${{ github.event.workflow_run.conclusion }}" \
            --arg run_url "${{ github.event.workflow_run.html_url }}" \
            --arg run_id "${{ github.event.workflow_run.id }}" \
            '{source:"failure-orchestrator",kind:"error",name:"workflow.failure",metadata:{workflow:$workflow,conclusion:$conclusion,run_url:$run_url,run_id:$run_id}}' \
            | curl -sS -X POST "${JULES_BASE_URL%/}/api/events" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $JULES_API_KEY" \
                --data-binary @- >/dev/null

      - name: AI triage eligibility
        id: ai_eligible
        run: echo "eligible=true" >> "$GITHUB_OUTPUT"

      - name: Ensure routing labels exist
        run: |
          gh label create failure-routing --color d93f0b --description "Failure orchestrator routing" 2>/dev/null || true
          gh label create ai-triage --color 5319e7 --description "AI triage required" 2>/dev/null || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for existing triage marker
        id: existing_marker
        run: |
          RUN_REF="run-id:${{ github.event.workflow_run.id }}"
          WF_NAME="${{ github.event.workflow_run.name }}"
          INCIDENT_TITLE="Incident: ${WF_NAME} fehlgeschlagen"

          # Check for exact run-id marker (existing dedup)
          ISSUE_COUNT="$(gh issue list --state open --search "$RUN_REF in:body" --json number --jq 'length')"
          PR_COUNT="$(gh pr list --state open --search "$RUN_REF in:body" --json number --jq 'length')"

          # Check for open issue with exact incident title (robust dedup, independent of search parser behavior)
          WF_ISSUE_COUNT="$(gh issue list --state open --label failure-routing --json title --jq --arg title "$INCIDENT_TITLE" '[.[] | select(.title == $title)] | length')"

          echo "marker_issue_count=$ISSUE_COUNT"
          echo "marker_pr_count=$PR_COUNT"
          echo "workflow_issue_count=$WF_ISSUE_COUNT"

          if [ "$ISSUE_COUNT" -gt 0 ] || [ "$PR_COUNT" -gt 0 ] || [ "$WF_ISSUE_COUNT" -gt 0 ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ai-triage:
    name: AI Triage & Fix PR
    needs: [route-failure]
    if: >-
      needs.route-failure.outputs.ai_eligible == 'true' &&
      needs.route-failure.outputs.marker_exists != 'true'
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0


      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install system tools
        run: sudo apt-get update && sudo apt-get install -y jq gh

      - run: npm ci

      - name: Sanitize user input
        run: |
          # Defensive input sanitization for workflow event data
          echo "✅ Input sanitization for workflow events enabled"

      - name: Normalize environment aliases
        run: |
          source tools/export_env.sh
          npx tsx tools/preflight.ts ai

      - name: PR backlog guardrail (max 2 codex PRs)
        id: pr_guardrail
        run: |
          OPEN_COUNT="$(gh pr list --state open --search 'head:codex/' --json number --jq 'length')"
          echo "open_count=$OPEN_COUNT" >> "$GITHUB_OUTPUT"
          [ "$OPEN_COUNT" -ge 2 ] && echo "blocked=true" >> "$GITHUB_OUTPUT" || echo "blocked=false" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Attempt safe autofix
        if: steps.pr_guardrail.outputs.blocked != 'true'
        run: |
          npx prettier --write . 2>/dev/null || true
          npx eslint . --fix 2>/dev/null || true
        env:
          AI_MAX_CALLS: '20'
          max_conflict_files: '10'
          max_file_bytes: '200000'
          binary_heuristic_threshold: '0.15'
          FORBID_WORKFLOW_EDITS: '1'

      - name: Validate fix
        id: validate
        if: steps.pr_guardrail.outputs.blocked != 'true'
        run: |
          set +e
          npm run db:generate && npm run lint && npm run typecheck && npm test && npm run build
          echo "status=$?" >> "$GITHUB_OUTPUT"

      - name: Create fix PR
        if: steps.pr_guardrail.outputs.blocked != 'true' && steps.validate.outputs.status == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: '0'
        run: |
          RUN_REF="run-id:${{ github.event.workflow_run.id }}"
          git diff --quiet && { echo "No changes"; exit 0; }

          WORKFLOW_SLUG="$(echo "${{ github.event.workflow_run.name }}" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9' '-')"
          BRANCH="codex/${WORKFLOW_SLUG}-${{ github.event.workflow_run.id }}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "fix: ai triage for ${{ github.event.workflow_run.name }}"
          git push -u origin "$BRANCH"

          gh pr create \
            --title "fix: ai triage for ${{ github.event.workflow_run.name }}" \
            --base "${{ github.event.workflow_run.head_branch }}" \
            --head "$BRANCH" \
            --body "## Was geändert\n- Safe-Autofix (Format/Lint) auf Basis des fehlgeschlagenen Runs ausgeführt.\n- Validierte Änderungen als separater Fix-Branch erstellt.\n\n## Warum\n- Fehlgeschlagenen Workflow deterministisch und reproduzierbar beheben.\n\n## Wie getestet\n- npm run lint\n- npm run typecheck\n- npm test\n- npm run build\n\n## Risiko/Backout\n- Risiko: Unzureichende Auto-Fixes für komplexe Ursachen.\n- Backout: Fix-PR schließen oder revertieren; Original-Branch bleibt unverändert.\n\nMarker: ${RUN_REF}"

      - name: Fallback issue
        if: steps.pr_guardrail.outputs.blocked == 'true' || steps.validate.outputs.status != '0'
        run: |
          RUN_REF="run-id:${{ github.event.workflow_run.id }}"
          gh issue create \
            --title "Incident: ${{ github.event.workflow_run.name }} fehlgeschlagen" \
            --body "Workflow: ${{ github.event.workflow_run.name }}\nRun: ${{ github.event.workflow_run.html_url }}\nMarker: ${RUN_REF}\n\nAuto-Fix war nicht möglich." \
            --label failure-routing --label ai-triage || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  close-resolved-incidents:
    name: Close Resolved Incidents
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.name != 'failure-orchestrator'
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    permissions:
      issues: write
    steps:
      - name: Install gh and jq
        run: sudo apt-get update && sudo apt-get install -y gh jq

      - name: Close resolved incident issues
        run: |
          WF_NAME="${{ github.event.workflow_run.name }}"
          INCIDENT_TITLE="Incident: ${WF_NAME} fehlgeschlagen"
          ISSUE_NUMBERS="$(gh issue list --state open --label failure-routing \
            --json number,title --jq \
            --arg t "$INCIDENT_TITLE" '[.[] | select(.title == $t)] | .[].number')"
          for NUM in $ISSUE_NUMBERS; do
            gh issue comment "$NUM" \
              --body "✅ Workflow **${WF_NAME}** hat erfolgreich abgeschlossen. Auto-Close." || true
            gh issue close "$NUM" --reason completed
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-routing-issue:
    name: Manual Triage Issue
    needs: [route-failure, ai-triage]
    if: >-
      always() &&
      needs.route-failure.outputs.marker_exists != 'true' &&
      needs.route-failure.outputs.ai_eligible != 'true'
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    permissions:
      issues: write
    steps:
      - name: Create manual triage issue
        run: |
          RUN_REF="run-id:${{ github.event.workflow_run.id }}"
          gh label create failure-routing --color d93f0b 2>/dev/null || true
          gh issue create \
            --title "Manual triage: ${{ github.event.workflow_run.name }}" \
            --body "Workflow: ${{ github.event.workflow_run.name }}\nRun: ${{ github.event.workflow_run.html_url }}\nMarker: ${RUN_REF}\n\nAI-Preflight nicht erfüllt. Manuelle Analyse erforderlich." \
            --label failure-routing || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
