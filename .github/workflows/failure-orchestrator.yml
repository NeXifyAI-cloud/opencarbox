name: failure-orchestrator

on:
  workflow_run:
    workflows: ["*"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  NODE_VERSION: '20'

jobs:
  route-failure:
    name: Route Failure
    if: >-
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.name != 'failure-orchestrator'
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    outputs:
      ai_eligible: ${{ steps.ai_eligible.outputs.eligible }}
      marker_exists: ${{ steps.existing_marker.outputs.exists }}
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install system tools
        run: sudo apt-get update && sudo apt-get install -y jq gh

      - run: pnpm i --frozen-lockfile

      - name: Sanitize user input
        run: |
          # Defensive input sanitization for workflow event data
          echo "✅ Input sanitization for workflow events enabled"

      - name: Normalize environment aliases
        run: |
          source tools/export_env.sh
          npx tsx tools/preflight.ts ai

      - name: Route failure event to Jules
        env:
          WF_NAME: ${{ github.event.workflow_run.name }}
          WF_CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          WF_RUN_URL: ${{ github.event.workflow_run.html_url }}
          WF_RUN_ID: ${{ github.event.workflow_run.id }}
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          JULES_BASE_URL: ${{ secrets.JULES_BASE_URL }}
        run: |
          if [ -z "${JULES_API_KEY:-}" ] || [ -z "${JULES_BASE_URL:-}" ]; then
            echo "Jules routing skipped (missing JULES_API_KEY or JULES_BASE_URL)."
            exit 0
          fi
          jq -n \
            --arg workflow "$WF_NAME" \
            --arg conclusion "$WF_CONCLUSION" \
            --arg run_url "$WF_RUN_URL" \
            --arg run_id "$WF_RUN_ID" \
            '{source:"failure-orchestrator",kind:"error",name:"workflow.failure",metadata:{workflow:$workflow,conclusion:$conclusion,run_url:$run_url,run_id:$run_id}}' \
            | curl -sS -X POST "${JULES_BASE_URL%/}/api/events" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $JULES_API_KEY" \
                --data-binary @- >/dev/null

      - name: AI triage eligibility
        id: ai_eligible
        run: echo "eligible=true" >> "$GITHUB_OUTPUT"

      - name: Ensure routing labels exist
        run: |
          gh label create failure-routing --color d93f0b --description "Failure orchestrator routing" 2>/dev/null || true
          gh label create ai-triage --color 5319e7 --description "AI triage required" 2>/dev/null || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for existing triage marker
        id: existing_marker
        env:
          WF_RUN_ID: ${{ github.event.workflow_run.id }}
          WF_NAME: ${{ github.event.workflow_run.name }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_REF="run-id:$WF_RUN_ID"
          INCIDENT_TITLE="Incident: ${WF_NAME} fehlgeschlagen"

          # Check for exact run-id marker (existing dedup)
          ISSUE_COUNT=$(gh issue list --state open --search "$RUN_REF in:body" --json number --jq 'length')
          PR_COUNT=$(gh pr list --state open --search "$RUN_REF in:body" --json number --jq 'length')

          # Check for open issue with exact incident title
          WF_ISSUE_COUNT=$(gh issue list --state open --label failure-routing --json title --jq --arg title "$INCIDENT_TITLE" '[.[] | select(.title == $title)] | length')

          if [ "$ISSUE_COUNT" -gt 0 ] || [ "$PR_COUNT" -gt 0 ] || [ "$WF_ISSUE_COUNT" -gt 0 ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

  ai-triage:
    name: AI Triage & Fix PR
    needs: [route-failure]
    if: >-
      needs.route-failure.outputs.ai_eligible == 'true' &&
      needs.route-failure.outputs.marker_exists != 'true'
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout trusted scripts
        uses: actions/checkout@v6

      - name: Secure Checkout of failed code
        env:
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          git fetch origin $HEAD_SHA
          git checkout FETCH_HEAD

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install system tools
        run: sudo apt-get update && sudo apt-get install -y jq gh

      - run: pnpm i --frozen-lockfile

      - name: PR backlog guardrail (max 2 codex PRs)
        id: pr_guardrail
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OPEN_COUNT=$(gh pr list --state open --search 'head:codex/' --json number --jq 'length')
          echo "open_count=$OPEN_COUNT" >> "$GITHUB_OUTPUT"
          [ "$OPEN_COUNT" -ge 2 ] && echo "blocked=true" >> "$GITHUB_OUTPUT" || echo "blocked=false" >> "$GITHUB_OUTPUT"

      - name: Attempt safe autofix
        if: steps.pr_guardrail.outputs.blocked != 'true'
        run: |
          pnpm -s prettier --write . 2>/dev/null || true
          pnpm -s eslint . --fix 2>/dev/null || true
        env:
          AI_MAX_CALLS: '20'
          max_conflict_files: '10'
          max_file_bytes: '200000'
          binary_heuristic_threshold: '0.15'
          FORBID_WORKFLOW_EDITS: '1'

      - name: Validate fix
        id: validate
        if: steps.pr_guardrail.outputs.blocked != 'true'
        run: |
          set +e
          pnpm db:generate && pnpm lint && pnpm typecheck && pnpm test && pnpm build
          echo "status=$?" >> "$GITHUB_OUTPUT"

      - name: Create fix PR
        if: steps.pr_guardrail.outputs.blocked != 'true' && steps.validate.outputs.status == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WF_NAME: ${{ github.event.workflow_run.name }}
          WF_RUN_ID: ${{ github.event.workflow_run.id }}
          WF_HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          HUSKY: '0'
        run: |
          RUN_REF="run-id:$WF_RUN_ID"
          git diff --quiet && { echo "No changes"; exit 0
          }

          WORKFLOW_SLUG=$(echo "$WF_NAME" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9' '-')
          BRANCH="codex/${WORKFLOW_SLUG}-$WF_RUN_ID"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "fix: ai triage for $WF_NAME"
          git push -u origin "$BRANCH"

          gh pr create \
            --title "fix: ai triage for $WF_NAME" \
            --base "$WF_HEAD_BRANCH" \
            --head "$BRANCH" \
            --body "## Was geändert
- Safe-Autofix (Format/Lint) auf Basis des fehlgeschlagenen Runs ausgeführt.
- Validierte Änderungen als separater Fix-Branch erstellt.

## Warum
- Fehlgeschlagenen Workflow deterministisch und reproduzierbar beheben.

## Wie getestet
- pnpm lint
- pnpm typecheck
- pnpm test
- pnpm build

## Risiko/Backout
- Risiko: Unzureichende Auto-Fixes für komplexe Ursachen.
- Backout: Fix-PR schließen oder revertieren; Original-Branch bleibt unverändert.

Marker: ${RUN_REF}"

      - name: Fallback issue
        if: steps.pr_guardrail.outputs.blocked == 'true' || steps.validate.outputs.status != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WF_NAME: ${{ github.event.workflow_run.name }}
          WF_RUN_ID: ${{ github.event.workflow_run.id }}
          WF_RUN_URL: ${{ github.event.workflow_run.html_url }}
        run: |
          RUN_REF="run-id:$WF_RUN_ID"
          gh issue create \
            --title "Incident: ${WF_NAME} fehlgeschlagen" \
            --body "Workflow: ${WF_NAME}\nRun: ${WF_RUN_URL}\nMarker: ${RUN_REF}\n\nAuto-Fix war nicht möglich." \
            --label failure-routing --label ai-triage || true

  close-resolved-incidents:
    name: Close Resolved Incidents
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.name != 'failure-orchestrator'
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    permissions:
      issues: write
    steps:
      - name: Install gh and jq
        run: sudo apt-get update && sudo apt-get install -y gh jq

      - name: Close resolved incident issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WF_NAME: ${{ github.event.workflow_run.name }}
        run: |
          INCIDENT_TITLE="Incident: ${WF_NAME} fehlgeschlagen"
          ISSUE_NUMBERS=$(gh issue list --state open --label failure-routing \
            --json number,title --jq \
            --arg t "$INCIDENT_TITLE" '[.[] | select(.title == $title)] | .[].number')
          for NUM in $ISSUE_NUMBERS; do
            gh issue comment "$NUM" \
              --body "✅ Workflow **${WF_NAME}** hat erfolgreich abgeschlossen. Auto-Close." || true
            gh issue close "$NUM" --reason completed
          done

  create-routing-issue:
    name: Manual Triage Issue
    needs: [route-failure, ai-triage]
    if: >-
      always() &&
      needs.route-failure.outputs.marker_exists != 'true' &&
      needs.route-failure.outputs.ai_eligible != 'true'
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    permissions:
      issues: write
    steps:
      - name: Create manual triage issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WF_NAME: ${{ github.event.workflow_run.name }}
          WF_RUN_ID: ${{ github.event.workflow_run.id }}
          WF_RUN_URL: ${{ github.event.workflow_run.html_url }}
        run: |
          RUN_REF="run-id:$WF_RUN_ID"
          gh label create failure-routing --color d93f0b 2>/dev/null || true
          gh issue create \
            --title "Manual triage: ${WF_NAME}" \
            --body "Workflow: ${WF_NAME}\nRun: ${WF_RUN_URL}\nMarker: ${RUN_REF}\n\nAI-Preflight nicht erfüllt. Manuelle Analyse erforderlich." \
            --label failure-routing || true
