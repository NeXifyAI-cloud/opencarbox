name: Fast Gate

on:
  pull_request:
  push:
    branches: [main, develop]

jobs:
  fast-gate:
    name: Fast Gate (Secrets/Lint/Typecheck/Smoke)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CI: "true"
      TZ: "UTC"
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: '20'
          cache: npm

      - name: Cache Next.js
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: .next/cache
          key: next-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('next.config.*', 'src/**', 'app/**', 'pages/**') }}
          restore-keys: |
            next-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            next-cache-${{ runner.os }}-

      - name: Install dependencies
        run: |
          mkdir -p logs
          npm ci 2>&1 | tee logs/install.log

      - name: Secret scan
        run: node scripts/ci-secret-guard.js 2>&1 | tee logs/secret-guard.log

      - name: Lint
        run: npm run lint 2>&1 | tee logs/lint.log

      - name: Typecheck
        run: npm run type-check 2>&1 | tee logs/typecheck.log

      - name: Next build smoke
        run: npm run build -- --no-lint 2>&1 | tee logs/build-smoke.log

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: fast-gate-logs-${{ github.run_id }}
          path: logs/*.log
          if-no-files-found: warn
