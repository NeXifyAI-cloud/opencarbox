name: Oracle (merge safety)

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, ready_for_review]

permissions:
  pull-requests: write
  contents: read

jobs:
  oracle:
    runs-on: ubuntu-latest
    steps:
      - name: Block needs-human
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        run: |
          pr="${{ github.event.pull_request.number }}"
          labels="$(gh pr view "$pr" --json labels -q '.labels[].name' || true)"
          if echo "$labels" | grep -qx "needs-human"; then
            gh pr comment "$pr" --body "Oracle: needs-human present â†’ merge blocked."
            exit 1
          fi

      - name: Ensure required checks green
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        run: |
          pr="${{ github.event.pull_request.number }}"
          gh pr checks "$pr" --required --watch
