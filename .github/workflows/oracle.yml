name: Oracle (autofix safety gate)

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, ready_for_review]

permissions:
  pull-requests: write
  contents: read
  checks: read

jobs:
  oracle:
    if: contains(github.event.pull_request.labels.*.name, 'autofix')
    runs-on: ubuntu-latest
    steps:
      - name: Enforce needs-human blocking
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        run: |
          pr="${{ github.event.pull_request.number }}"
          labels="$(gh pr view "$pr" --json labels -q '.labels[].name' | tr '\n' ' ')"
          if echo "$labels" | grep -q 'needs-human'; then
            gh pr comment "$pr" --body "Oracle: needs-human present â†’ auto-merge blocked."
            exit 1
          fi

      - name: Ensure required checks are green
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        run: |
          pr="${{ github.event.pull_request.number }}"
          gh pr checks "$pr" --required --watch
