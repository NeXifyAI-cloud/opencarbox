name: PR Backlog Worker (queue + autofix via NSCALE/DeepSeek)

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, labeled]
  schedule:
    - cron: "*/20 * * * *"
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Process a single PR number (e.g. 45)"
        required: false
        default: ""
      max_prs:
        description: "Max queued PRs to process per run"
        required: false
        default: "3"

permissions:
  contents: read
  pull-requests: write
  actions: read

concurrency:
  group: pr-backlog-worker
  cancel-in-progress: false

env:
  CI: "true"
  TZ: "UTC"
  QUEUE_LABEL: "nexifyai:queue"
  NEEDS_HUMAN_LABEL: "needs-human"
  MAX_AUTOFIX_ATTEMPTS: "2"

jobs:
  select:
    runs-on: ubuntu-latest
    outputs:
      prs: ${{ steps.sel.outputs.prs }}
    steps:
      - name: Select PRs
        id: sel
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -n "${{ inputs.pr_number }}" ]; then
            echo "prs=[${{ inputs.pr_number }}]" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Event-driven: if labeled/opened and has queue label, process just that PR.
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            pr="${{ github.event.pull_request.number }}"
            labels="$(echo '${{ toJson(github.event.pull_request.labels) }}' | jq -r '.[].name' || true)"
            if echo "$labels" | grep -qx "${QUEUE_LABEL}"; then
              echo "prs=[$pr]" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # Scheduled: process oldest queued PRs
          max="${{ inputs.max_prs }}"
          prs="$(gh pr list --state open --label "${QUEUE_LABEL}" --json number,createdAt \
                -q 'sort_by(.createdAt) | .[0:'"$max"'] | map(.number)')"
          echo "prs=$prs" >> $GITHUB_OUTPUT

  process:
    needs: select
    if: needs.select.outputs.prs != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pr: ${{ fromJson(needs.select.outputs.prs) }}

    steps:
      - name: Load PR metadata
        id: meta
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          pr="${{ matrix.pr }}"
          gh pr view "$pr" --json headRefName,baseRefName,isCrossRepository,authorAssociation,title > pr.json
          echo "head=$(jq -r .headRefName pr.json)" >> $GITHUB_OUTPUT
          echo "base=$(jq -r .baseRefName pr.json)" >> $GITHUB_OUTPUT
          echo "cross=$(jq -r .isCrossRepository pr.json)" >> $GITHUB_OUTPUT
          echo "assoc=$(jq -r .authorAssociation pr.json)" >> $GITHUB_OUTPUT

      - name: Trust boundary guard
        id: trust
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ steps.meta.outputs.cross }}" = "true" ]; then
            echo "allowed=false" >> $GITHUB_OUTPUT; exit 0
          fi
          case "${{ steps.meta.outputs.assoc }}" in
            MEMBER|COLLABORATOR|OWNER) echo "allowed=true" >> $GITHUB_OUTPUT ;;
            *) echo "allowed=false" >> $GITHUB_OUTPUT ;;
          esac

      - name: Mark needs-human if untrusted
        if: steps.trust.outputs.allowed != 'true'
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        run: |
          pr="${{ matrix.pr }}"
          gh pr edit "$pr" --add-label "${NEEDS_HUMAN_LABEL}" >/dev/null 2>&1 || true
          gh pr comment "$pr" --body "NeXifyAI: PR cannot be auto-processed (fork or untrusted). Marked needs-human." >/dev/null 2>&1 || true

      - name: Checkout PR head
        if: steps.trust.outputs.allowed == 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ steps.meta.outputs.head }}
          fetch-depth: 0

      - name: Setup Node
        if: steps.trust.outputs.allowed == 'true'
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        if: steps.trust.outputs.allowed == 'true'
        run: npm ci

      - name: Run fast checks (logs)
        if: steps.trust.outputs.allowed == 'true'
        shell: bash
        run: |
          set -o pipefail
          mkdir -p logs
          npm run security:scan-secrets | tee logs/secret-scan.log
          npm run lint | tee logs/lint.log
          npm run type-check | tee logs/type-check.log
          npm run build | tee logs/build.log

      - name: Create error summary on failure
        if: failure() && steps.trust.outputs.allowed == 'true'
        run: |
          node scripts/ci-classify-failure.js logs/build.log || true
          test -f logs/error-summary.json || echo '{"kind":"unknown"}' > logs/error-summary.json

      - name: Attempt limiter (per PR)
        if: failure() && steps.trust.outputs.allowed == 'true'
        id: limit
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          pr="${{ matrix.pr }}"
          body="$(gh pr view "$pr" --json body -q .body || true)"
          n="$(printf "%s" "$body" | sed -n 's/^Autofix-Attempt:\s*\([0-9]\+\).*$/\1/p' | tail -n1)"
          [ -z "$n" ] && n="0"
          n=$((n+1))
          echo "attempt=$n" >> $GITHUB_OUTPUT
          if [ "$n" -gt "${MAX_AUTOFIX_ATTEMPTS}" ]; then
            echo "allowed=false" >> $GITHUB_OUTPUT
          else
            echo "allowed=true" >> $GITHUB_OUTPUT
          fi
          gh pr edit "$pr" --body $'Autofix-Attempt: '"$n"$'\n\n'"$body" >/dev/null 2>&1 || true

      - name: Stop if attempts exceeded
        if: failure() && steps.limit.outputs.allowed != 'true' && steps.trust.outputs.allowed == 'true'
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        run: |
          pr="${{ matrix.pr }}"
          gh pr edit "$pr" --add-label "${NEEDS_HUMAN_LABEL}" >/dev/null 2>&1 || true
          gh pr comment "$pr" --body "NeXifyAI: Autofix stopped (attempt limit exceeded). Marked needs-human." >/dev/null 2>&1 || true

      - name: AI Autofix (NSCALE + DeepSeek only)
        if: failure() && steps.limit.outputs.allowed == 'true' && steps.trust.outputs.allowed == 'true'
        env:
          NSCALE_API_KEY: ${{ secrets.NSCALE_API_KEY }}
          NSCALE_BASE_URL: ${{ vars.NSCALE_BASE_URL }}
          NSCALE_MODEL: ${{ vars.NSCALE_MODEL }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_BASE_URL: ${{ vars.DEEPSEEK_BASE_URL }}
          DEEPSEEK_MODEL: ${{ vars.DEEPSEEK_MODEL }}
        run: node scripts/ai/autofix-runner.mjs

      - name: Push back to PR head (same-repo only)
        if: steps.trust.outputs.allowed == 'true'
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          # Push only if there are new commits
          if git log -1 --pretty=%B | grep -q '^fix(ci):'; then
            git push "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" "HEAD:${{ steps.meta.outputs.head }}"
          fi

      - name: Remove from queue when green
        if: success() && steps.trust.outputs.allowed == 'true'
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        run: |
          pr="${{ matrix.pr }}"
          gh pr edit "$pr" --remove-label "${QUEUE_LABEL}" >/dev/null 2>&1 || true
          gh pr comment "$pr" --body "NeXifyAI: Green. Removed from queue." >/dev/null 2>&1 || true
