name: pr-backlog-worker

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, labeled]
  schedule:
    - cron: "*/20 * * * *"
  workflow_dispatch:
    inputs:
      pr_number:
        required: false
        default: ""

permissions:
  contents: read
  pull-requests: write
  actions: read

concurrency:
  group: pr-backlog-worker
  cancel-in-progress: false

env:
  CI: "true"
  TZ: "UTC"
  QUEUE_LABEL: "nexifyai:queue"
  NEEDS_HUMAN_LABEL: "needs-human"

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - name: Select PR
        id: sel
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${{ inputs.pr_number }}" ]; then
            echo "pr=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            pr="${{ github.event.pull_request.number }}"
            labels="$(echo '${{ toJson(github.event.pull_request.labels) }}' | jq -r '.[].name' || true)"
            if echo "$labels" | grep -qx "${QUEUE_LABEL}"; then
              echo "pr=$pr" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          pr="$(gh pr list --state open --label "${QUEUE_LABEL}" --json number,createdAt -q 'sort_by(.createdAt) | .[0].number' || true)"
          echo "pr=$pr" >> $GITHUB_OUTPUT

      - name: Stop if no PR
        if: steps.sel.outputs.pr == ''
        run: exit 0

      - name: Load PR meta
        id: meta
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        run: |
          pr="${{ steps.sel.outputs.pr }}"
          gh pr view "$pr" --json headRefName,isCrossRepository,authorAssociation > pr.json
          echo "head=$(jq -r .headRefName pr.json)" >> $GITHUB_OUTPUT
          echo "cross=$(jq -r .isCrossRepository pr.json)" >> $GITHUB_OUTPUT
          echo "assoc=$(jq -r .authorAssociation pr.json)" >> $GITHUB_OUTPUT

      - name: Trust boundary guard
        id: trust
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ steps.meta.outputs.cross }}" = "true" ]; then echo "ok=false" >> $GITHUB_OUTPUT; exit 0; fi
          case "${{ steps.meta.outputs.assoc }}" in
            MEMBER|COLLABORATOR|OWNER) echo "ok=true" >> $GITHUB_OUTPUT ;;
            *) echo "ok=false" >> $GITHUB_OUTPUT ;;
          esac

      - name: Mark needs-human if untrusted
        if: steps.trust.outputs.ok != 'true'
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        run: |
          pr="${{ steps.sel.outputs.pr }}"
          gh pr edit "$pr" --add-label "${NEEDS_HUMAN_LABEL}" || true
          gh pr comment "$pr" --body "NeXifyAI: cannot auto-process (fork/untrusted). needs-human." || true

      - name: Checkout PR head
        if: steps.trust.outputs.ok == 'true'
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          ref: ${{ steps.meta.outputs.head }}
          fetch-depth: 0

      - name: Setup Node
        if: steps.trust.outputs.ok == 'true'
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: "20"
          cache: "npm"

      - name: Run quality gate locally (feedback comment)
        if: steps.trust.outputs.ok == 'true'
        env:
          GH_TOKEN: ${{ secrets.NEXIFYAI_BOT_TOKEN }}
        shell: bash
        run: |
          set -o pipefail
          mkdir -p logs
          npm ci
          npm run quality-gate | tee logs/workflow.log
          pr="${{ steps.sel.outputs.pr }}"
          if [ "${PIPESTATUS[0]}" -eq 0 ]; then
            gh pr edit "$pr" --remove-label "${QUEUE_LABEL}" || true
            gh pr comment "$pr" --body "NeXifyAI: quality-gate GREEN. Removed from queue." || true
          else
            node scripts/ci-classify-failure.js logs/workflow.log || true
            gh pr comment "$pr" --body "NeXifyAI: quality-gate FAILED. Autofix will run via workflow_run gates (see logs/artifacts)." || true
            exit 1
          fi
