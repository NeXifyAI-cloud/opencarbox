name: PR Gate (DOS v1.1)

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  check-pr-description:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate PR Description
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || "";

            // 1. Funnel-Zuordnung Section Check (G1)
            const funnelSectionRegex = /1\.\s+Funnel-Zuordnung\s+\(G1\s+–\s+Pflicht\)/i;
            if (!funnelSectionRegex.test(body)) {
              core.setFailed("PR description is missing the '1. Funnel-Zuordnung (G1 – Pflicht)' section.");
            }

            // 2. Funnel-Zuordnung Checkboxes Check (at least one [x] or [X])
            // We look for the funnel checkboxes following the section header
            const funnelCheckboxesPart = body.split(funnelSectionRegex)[1] || "";
            const hasCheckedFunnel = /-\s+\[[xX]\]\s+(Awareness|Education|Consideration|Conversion|Retention)/i.test(funnelCheckboxesPart);

            if (!hasCheckedFunnel) {
              core.setFailed("At least one Funnel stage must be selected in the 'Funnel-Zuordnung' section (use [x]).");
            }

            // 3. Tracking Section Check (G4) if it's a feature
            const isFeature = context.payload.pull_request.title.startsWith('feat');
            if (isFeature) {
              const trackingSectionRegex = /5\.\s+Tracking\s+\(G4\s+–\s+Pflicht\)/i;
              if (!trackingSectionRegex.test(body)) {
                core.setFailed("Feature PRs must contain the '5. Tracking (G4 – Pflicht)' section.");
              }
            }
