# Fully Autonomous Sync from audit-fix-deploy to main
name: sync-to-main

on:
  push:
    branches:
      - audit-fix-deploy-*
  schedule:
    - cron: '0 3 * * *' # Daily at 03:00 UTC
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source branch to sync (defaults to latest audit-fix-deploy-* branch)'
        required: false
        type: string

concurrency:
  group: sync-to-main
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

env:
  TARGET_BRANCH: ${{ github.event.repository.default_branch || 'main' }}

jobs:
  sync-to-main:
    name: Sync to Main
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
          fetch-depth: 0

      - name: Install gh and jq
        run: sudo apt-get update && sudo apt-get install -y gh jq

      - name: Resolve source branch
        id: resolve
        run: |
          # Priority: workflow_dispatch input > push event branch > latest audit-fix-deploy-* branch
          if [ -n "${{ github.event.inputs.source_branch }}" ]; then
            SOURCE="${{ github.event.inputs.source_branch }}"
          elif [ "${{ github.event_name }}" = "push" ]; then
            SOURCE="${{ github.ref_name }}"
          else
            # Scheduled run: find latest audit-fix-deploy-* branch
            git fetch --prune origin
            SOURCE=$(git branch -r --list 'origin/audit-fix-deploy-*' --sort=-committerdate | head -1 | sed 's|origin/||;s/^[[:space:]]*//')
          fi

          if [ -z "$SOURCE" ]; then
            echo "No audit-fix-deploy-* branch found. Nothing to sync."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "source_branch=$SOURCE" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "Resolved source branch: $SOURCE"

      - name: Check or create sync PR
        if: steps.resolve.outputs.skip != 'true'
        run: |
          SOURCE_BRANCH="${{ steps.resolve.outputs.source_branch }}"
          echo "üîç Checking for existing sync PR from $SOURCE_BRANCH..."

          # Check if an open sync PR already exists for this branch
          PR_NUMBER=$(gh pr list --base "$TARGET_BRANCH" --head "$SOURCE_BRANCH" --state open --json number --jq '.[0].number // empty')

          if [ -n "$PR_NUMBER" ]; then
            echo "‚úÖ Open PR #$PR_NUMBER exists for $SOURCE_BRANCH ‚Üí $TARGET_BRANCH"
            echo "pr_number=$PR_NUMBER" >> "$GITHUB_ENV"
          else
            echo "No existing PR found. Checking for changes..."

            git fetch origin "$SOURCE_BRANCH"
            git fetch origin "$TARGET_BRANCH"

            COMMITS_AHEAD=$(git rev-list --count "origin/$TARGET_BRANCH..origin/$SOURCE_BRANCH")

            if [ "$COMMITS_AHEAD" = "0" ]; then
              echo "‚úÖ No changes to sync - branches are up to date"
              exit 0
            fi

            echo "Found $COMMITS_AHEAD commits to sync. Creating PR..."

            NEW_PR=$(gh pr create \
              --title "chore: sync $SOURCE_BRANCH ‚Üí $TARGET_BRANCH [autonomous]" \
              --base "$TARGET_BRANCH" \
              --head "$SOURCE_BRANCH" \
              --body "Automated sync from $SOURCE_BRANCH to $TARGET_BRANCH. Commits ahead: $COMMITS_AHEAD. This PR will auto-merge when CI passes." \
              --label "auto-merge" 2>&1 | tail -1 | grep -oP '\d+$')

            echo "pr_number=$NEW_PR" >> "$GITHUB_ENV"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: '0'

      - name: Check CI and enable auto-merge
        if: steps.resolve.outputs.skip != 'true' && env.pr_number != ''
        run: |
          echo "üîç Enabling auto-merge on PR #$pr_number..."
          gh pr merge --squash --auto "$pr_number" || echo "Auto-merge already enabled or not possible"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: '0'
