name: workflow-manifest-check

on:
  pull_request:
    paths:
      - '.github/workflows/**'
      - 'NOTES/automation-manifest.md'

permissions:
  contents: read

jobs:
  manifest:
    name: Require automation manifest update
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify manifest changed with workflow updates
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          WORKFLOW_CHANGED=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" -- '.github/workflows/*.yml' | wc -l | tr -d ' ')
          MANIFEST_CHANGED=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" -- 'NOTES/automation-manifest.md' | wc -l | tr -d ' ')

          if [ "$WORKFLOW_CHANGED" -gt 0 ] && [ "$MANIFEST_CHANGED" -eq 0 ]; then
            echo "::error::Workflow files changed without NOTES/automation-manifest.md update."
            exit 1
          fi

          echo "Manifest check passed."
