# GitLab CI/CD Configuration for OpenCarBox
# Mirrored from GitHub with Mem0 integration

image: node:20-alpine

stages:
  - analyze
  - test
  - build
  - deploy

variables:
  NODE_ENV: production
  CI: "true"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .next/cache/

before_script:
  - npm ci --prefer-offline

analyze:
  stage: analyze
  script:
    - echo "üîç Analyzing with Mem0 integration"
    - node scripts/mem0-integration.ts
    - npm run lint
    - npm run type-check
  artifacts:
    when: always
    paths:
      - .mem0/
    reports:
      junit: test-results/junit.xml

test:
  stage: test
  script:
    - npm run test:unit
    - npm run test:integration
  artifacts:
    when: always
    paths:
      - coverage/

build:
  stage: build
  script:
    - npm run build
  artifacts:
    paths:
      - .next/
      - public/
    expire_in: 1 week

deploy:
  stage: deploy
  script:
    - echo "üöÄ Deploying to Vercel"
    - npm run deploy
  only:
    - main
  environment:
    name: production
    url: https://opencarbox.ai

# Mem0 Memory Sync Job
mem0-sync:
  stage: analyze
  script:
    - echo "üß† Syncing memories with Mem0"
    - chmod +x scripts/gitlab-sync.sh
    - bash scripts/gitlab-sync.sh
  only:
    - schedules
    - web
  artifacts:
    paths:
      - .mem0/

# Mirror sync from GitHub
mirror-sync:
  stage: analyze
  script:
    - echo "üîÑ Mirroring from GitHub"
    - git fetch origin
    - git push --mirror gitlab
  only:
    - schedules
  variables:
    GIT_STRATEGY: none

# Health check for Mem0 integration
health-check:
  stage: analyze
  script:
    - echo "üè• Health Check for Mem0 Integration"
    - echo "1. Checking Mem0 directory..."
    - ls -la .mem0/ || echo "Mem0 directory not found"
    - echo "2. Checking integration scripts..."
    - ls -la scripts/mem0-integration.ts scripts/gitlab-sync.sh
    - echo "3. Checking GitLab connectivity..."
    - curl -s -H "PRIVATE-TOKEN: $GITLAB_PROJEKT_TOKEN" "https://gitlab.com/api/v4/projects/NeXifyAI-cloud%2Fopencarbox" | jq -r '.name' || echo "GitLab connectivity failed"
  artifacts:
    when: always
    paths:
      - .mem0/health-check.log