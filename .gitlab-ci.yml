# GitLab CI/CD Configuration for OpenCarBox
# Unified with GitHub Actions using npm

image: node:20-alpine

stages:
  - analyze
  - test
  - build
  - deploy

variables:
  NODE_ENV: production
  CI: "true"
  PNPM_HOME: "$CI_PROJECT_DIR/.npm-store"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .npm-store
    - node_modules/
    - .next/cache/

before_script:
  - corepack enable
  - corepack prepare npm@latest --activate
  - echo $PNPM_HOME
  - npm ci

analyze:
  stage: analyze
  script:
    - echo "üîç Analyzing with Mem0 integration"
    - npx tsx scripts/mem0-integration.ts
    - npm lint
    - npm typecheck
  artifacts:
    when: always
    paths:
      - .mem0/

test:
  stage: test
  script:
    - npm test
  artifacts:
    when: always
    paths:
      - coverage/

build:
  stage: build
  script:
    - npm build
  artifacts:
    paths:
      - .next/
      - public/
    expire_in: 1 week

deploy:
  stage: deploy
  script:
    - echo "üöÄ Deploying to Vercel"
    - npx vercel --token=$VERCEL_TOKEN --prod --yes
  only:
    - main
  environment:
    name: production
    url: https://opencarbox.ai

mem0-sync:
  stage: analyze
  script:
    - echo "üß† Syncing memories with Mem0"
    - chmod +x scripts/gitlab-sync.sh
    - bash scripts/gitlab-sync.sh
  only:
    - schedules
    - web

health-check:
  stage: analyze
  script:
    - echo "üè• Health Check for Integration"
    - npm tsx scripts/mcp-health-check.sh || echo "MCP Health Check failed"
  artifacts:
    when: always
    paths:
      - health-check.log
