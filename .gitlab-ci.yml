stages:
  - fast
  - full
  - autofix
  - mirror

variables:
  CI: "true"
  TZ: "UTC"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .npm/

.default_node_job: &default_node_job
  image: node:20
  before_script:
    - npm ci

fast_gate:
  <<: *default_node_job
  stage: fast
  script:
    - mkdir -p logs
    - npm run security:scan-secrets | tee logs/secret-scan.log
    - npm run lint | tee logs/lint.log
    - npm run type-check | tee logs/type-check.log
    - npm run build | tee logs/build.log
    - cat logs/*.log > logs/workflow.log
  artifacts:
    when: always
    paths:
      - logs/

full_gate:
  <<: *default_node_job
  stage: full
  script:
    - mkdir -p logs
    - npm run test -- --run | tee logs/test.log
    - npm run build | tee logs/build.log
    - cat logs/*.log > logs/workflow.log
  artifacts:
    when: always
    paths:
      - logs/

autofix:
  <<: *default_node_job
  stage: autofix
  rules:
    - when: on_failure
  script:
    - npm run ai:autofix || true
    - git config user.name "NeXifyAI Bot"
    - git config user.email "nexifyai-bot@gitlab.com"
    - git push origin HEAD:autofix/${CI_COMMIT_SHORT_SHA}
  allow_failure: true

mirror_to_github:
  stage: mirror
  image: alpine:3.20
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $GITHUB_SSH_PRIVATE_KEY'
  before_script:
    - apk add --no-cache git openssh-client
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$GITHUB_SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan -H github.com >> ~/.ssh/known_hosts
  script:
    - git remote add github git@github.com:NeXify-Chat-it-Automate-it/OpenCarBox.git || true
    - git push --prune github +refs/heads/*:refs/heads/* +refs/tags/*:refs/tags/*
