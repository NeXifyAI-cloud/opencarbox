// =============================================================================
// Prisma Schema - OpenCarBox & Carvantooo (PostgreSQL Production)
// =============================================================================
// Datenbank-Schema für die Multisite-Plattform
// PostgreSQL für Production, SQLite für lokale Entwicklung über env-Variable
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================================================
// NEXIFY ORACLE & MEMORY SYSTEM
// =============================================================================

/// Project Memory - Langzeitgedächtnis für Patterns & Erkenntnisse
model ProjectMemory {
  id          String   @id @default(cuid())
  type        String   // BEST_PRACTICE | ANTIPATTERN | KNOWLEDGE | TODO
  category    String   // z.B. "supabase", "stripe", "api"
  title       String
  content     String
  metadata    String?  // JSON als String speichern
  tags        String   // Komma-getrennte Tags für Suche

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("project_memory")
  @@index([type])
  @@index([category])
}

/// Audit Logs - Protokoll aller Agent-Aktionen
model AuditLog {
  user          String   // Agent oder Benutzer-ID
  id            String   @id @default(cuid())
  action        String   // z.B. "create_component", "fix_bug"
  resource      String   // Betroffene Datei/Ressource
  status        String   // SUCCESS | FAILURE | WARNING
  details       String?  // JSON als String
  errorMessage  String?  @map("error_message")
  stackTrace    String?  @map("stack_trace")
  durationMs    Int?     @map("duration_ms")

  createdAt     DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
  @@index([action])
  @@index([status])
  @@index([createdAt])
}

// =============================================================================
// BENUTZER & AUTHENTIFIZIERUNG
// =============================================================================

/// Benutzer der Plattform (Kunden, Mitarbeiter, Admins)
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  name          String?
  phone         String?
  image         String?
  role          String    @default("CUSTOMER") // CUSTOMER, EMPLOYEE, ADMIN

  // Relationen
  addresses     Address[]
  vehicles      Vehicle[]
  orders        Order[]
  appointments  Appointment[]
  reviews       Review[]

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

/// Adressen (Liefer- und Rechnungsadressen)
model Address {
  id            String      @id @default(cuid())
  userId        String      @map("user_id")
  type          String      @default("SHIPPING") // SHIPPING, BILLING

  // Adressfelder
  firstName     String      @map("first_name")
  lastName      String      @map("last_name")
  company       String?
  street        String
  streetNumber  String      @map("street_number")
  addressLine2  String?     @map("address_line_2")
  postalCode    String      @map("postal_code")
  city          String
  country       String      @default("AT")

  isDefault     Boolean     @default(false) @map("is_default")

  // Relationen
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  ordersShipping Order[]    @relation("ShippingAddress")
  ordersBilling  Order[]    @relation("BillingAddress")

  // Timestamps
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  @@map("addresses")
}

// =============================================================================
// FAHRZEUGE (Meine Garage)
// =============================================================================

/// Gespeicherte Fahrzeuge eines Benutzers
model Vehicle {
  id            String    @id @default(cuid())
  userId        String?   @map("user_id")

  // Fahrzeugdaten
  hsn           String?   // Herstellerschlüsselnummer (4-stellig)
  tsn           String?   // Typschlüsselnummer (3-stellig)
  licensePlate  String?   @map("license_plate") // Kennzeichen
  vin           String?   // Fahrgestellnummer

  brand         String    // Marke (z.B. "Volkswagen")
  model         String    // Modell (z.B. "Golf")
  variant       String?   // Variante (z.B. "VII GTI")
  year          Int       // Baujahr

  // Zusätzliche Infos
  nickname      String?   // Benutzerdefinierter Name
  mileage       Int?      // Kilometerstand
  lastService   DateTime? @map("last_service")
  nextTuv       DateTime? @map("next_tuv") // Nächste HU/AU

  // Relationen
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  orders        Order[]
  appointments  Appointment[]

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("vehicles")
}

// =============================================================================
// PRODUKTE (Carvantooo Shop)
// =============================================================================

/// Produktkategorien
model Category {
  id            String     @id @default(cuid())
  name          String
  slug          String     @unique
  description   String?
  image         String?

  // Hierarchie
  parentId      String?    @map("parent_id")
  parent        Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children      Category[] @relation("CategoryHierarchy")

  // Relationen
  products      Product[]

  // SEO
  metaTitle     String?    @map("meta_title")
  metaDescription String?  @map("meta_description")

  // Sortierung
  sortOrder     Int        @default(0) @map("sort_order")
  isActive      Boolean    @default(true) @map("is_active")

  // Timestamps
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  @@map("categories")
}

/// Produkte im Shop
model Product {
  id            String    @id @default(cuid())
  sku           String    @unique // Artikelnummer
  name          String
  slug          String    @unique
  description   String?

  // Preise
  price         Float
  comparePrice  Float?    @map("compare_price") // UVP/Streichpreis
  costPrice     Float?    @map("cost_price") // Einkaufspreis

  // Lager
  stock         Int       @default(0)
  lowStockAlert Int       @default(5) @map("low_stock_alert")
  trackStock    Boolean   @default(true) @map("track_stock")

  // Medien
  images        String    // Komma-getrennte Bild-URLs

  // Kategorisierung
  categoryId    String?   @map("category_id")
  category      Category? @relation(fields: [categoryId], references: [id])
  brand         String?   // Hersteller/Marke

  // Fahrzeug-Kompatibilität
  compatibleVehicles VehicleCompatibility[]

  // Varianten (z.B. Größen)
  variants      ProductVariant[]

  // Relationen
  orderItems    OrderItem[]
  reviews       Review[]
  relatedFrom   ProductRelation[] @relation("RelatedFrom")
  relatedTo     ProductRelation[] @relation("RelatedTo")

  // SEO
  metaTitle     String?   @map("meta_title")
  metaDescription String? @map("meta_description")

  // Status
  isActive      Boolean   @default(true) @map("is_active")
  isFeatured    Boolean   @default(false) @map("is_featured")

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("products")
}

/// Produkt-Varianten (z.B. verschiedene Größen)
model ProductVariant {
  id            String    @id @default(cuid())
  productId     String    @map("product_id")
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  sku           String    @unique
  name          String    // z.B. "Größe M"
  price         Float?    // Überschreibt Produktpreis wenn gesetzt
  stock         Int       @default(0)

  // Attribute
  attributes    String?   // JSON als String: { "size": "M", "color": "rot" }

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("product_variants")
}

/// Fahrzeug-Kompatibilität für Produkte
model VehicleCompatibility {
  id            String    @id @default(cuid())
  productId     String    @map("product_id")
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Fahrzeugdaten
  hsn           String?
  tsn           String?
  brand         String?
  model         String?
  yearFrom      Int?      @map("year_from")
  yearTo        Int?      @map("year_to")

  @@map("vehicle_compatibilities")
}

/// Produktrelationen (Cross-Selling)
model ProductRelation {
  id            String    @id @default(cuid())
  productId     String    @map("product_id")
  relatedId     String    @map("related_id")
  type          String    @default("RELATED") // RELATED, FREQUENTLY_BOUGHT, ACCESSORY

  product       Product   @relation("RelatedFrom", fields: [productId], references: [id], onDelete: Cascade)
  related       Product   @relation("RelatedTo", fields: [relatedId], references: [id], onDelete: Cascade)

  @@unique([productId, relatedId])
  @@map("product_relations")
}

// =============================================================================
// BESTELLUNGEN
// =============================================================================

/// Bestellungen
model Order {
  id                String      @id @default(cuid())
  orderNumber       String      @unique @map("order_number") // z.B. "CV-2024-0001"
  userId            String?     @map("user_id")
  vehicleId         String?     @map("vehicle_id")

  // Adressen
  shippingAddressId String?     @map("shipping_address_id")
  billingAddressId  String?     @map("billing_address_id")

  // Preise
  subtotal          Float
  shippingCost      Float       @default(0) @map("shipping_cost")
  taxAmount         Float       @default(0) @map("tax_amount")
  discount          Float       @default(0)
  total             Float

  // Zahlung
  paymentMethod     String?     @map("payment_method")
  paymentIntentId   String?     @unique @map("payment_intent_id") // Stripe Payment Intent
  paymentStatus     String      @default("PENDING") @map("payment_status") // PENDING, PAID, FAILED, REFUNDED

  // Status
  status            String      @default("PENDING") // PENDING, PROCESSING, SHIPPED, DELIVERED, CANCELLED, REFUNDED

  // Versand
  shippingMethod    String?     @map("shipping_method")
  trackingNumber    String?     @map("tracking_number")
  shippedAt         DateTime?   @map("shipped_at")
  deliveredAt       DateTime?   @map("delivered_at")

  // Notizen
  customerNote      String?     @map("customer_note")
  internalNote      String?     @map("internal_note")

  // Relationen
  user              User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  vehicle           Vehicle?    @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  shippingAddress   Address?    @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress    Address?    @relation("BillingAddress", fields: [billingAddressId], references: [id])
  items             OrderItem[]

  // Timestamps
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  @@map("orders")
}

/// Bestellpositionen
model OrderItem {
  id            String    @id @default(cuid())
  orderId       String    @map("order_id")
  productId     String?   @map("product_id")

  // Produktdaten (zum Zeitpunkt der Bestellung)
  sku           String
  name          String
  price         Float
  quantity      Int
  total         Float

  // Relationen
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@map("order_items")
}

// =============================================================================
// WERKSTATT-SERVICES (OpenCarBox)
// =============================================================================

/// Service-Kategorien
model ServiceCategory {
  id            String    @id @default(cuid())
  name          String
  slug          String    @unique
  description   String?
  image         String?
  sortOrder     Int       @default(0) @map("sort_order")

  services      Service[]

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("service_categories")
}

/// Werkstatt-Services
model Service {
  id            String    @id @default(cuid())
  categoryId    String?   @map("category_id")

  name          String
  slug          String    @unique
  description   String?

  // Preise
  priceFrom     Float?    @map("price_from")
  priceTo       Float?    @map("price_to")
  priceType     String    @default("FIXED") @map("price_type") // FIXED, FROM, ON_REQUEST

  // Dauer
  durationMinutes Int?    @map("duration_minutes")

  // Medien
  image         String?

  // Status
  isActive      Boolean   @default(true) @map("is_active")

  // Relationen
  category      ServiceCategory? @relation(fields: [categoryId], references: [id])
  appointments  Appointment[]

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("services")
}

/// Werkstatt-Termine
model Appointment {
  id            String    @id @default(cuid())
  userId        String?   @map("user_id")
  vehicleId     String?   @map("vehicle_id")
  serviceId     String    @map("service_id")

  // Termin
  date          DateTime
  timeSlot      String    @map("time_slot") // z.B. "09:00-10:00"

  // Kontakt (falls nicht eingeloggt)
  customerName  String?   @map("customer_name")
  customerEmail String?   @map("customer_email")
  customerPhone String?   @map("customer_phone")

  // Status
  status        String    @default("PENDING") // PENDING, CONFIRMED, IN_PROGRESS, COMPLETED, CANCELLED, NO_SHOW

  // Notizen
  customerNote  String?   @map("customer_note")
  internalNote  String?   @map("internal_note")

  // Relationen
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  vehicle       Vehicle?  @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  service       Service   @relation(fields: [serviceId], references: [id])

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("appointments")
}

// =============================================================================
// BEWERTUNGEN
// =============================================================================

/// Produkt- und Service-Bewertungen
model Review {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  productId     String?   @map("product_id")

  // Bewertung
  rating        Int       // 1-5
  title         String?
  content       String?

  // Status
  isVerified    Boolean   @default(false) @map("is_verified") // Verifizierter Kauf
  isApproved    Boolean   @default(false) @map("is_approved")

  // Relationen
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  product       Product?  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("reviews")
}

model SystemLog {
  id        String   @id @default(uuid())
  level     String   // info, warn, error
  message   String
  metadata  String?
  createdAt DateTime @default(now())

  @@index([level])
  @@index([createdAt])
  @@map("system_logs")
}
